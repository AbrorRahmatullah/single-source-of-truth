{% extends "header.html" %}

{% block title %}Divisions Management{% endblock %}

{% block content %}
    <!-- Sidebar -->
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Content -->
        <div class="content">
            <div class="content-header">
                <h2 class="content-title">Divisions Management</h2>
                <p class="content-subtitle">Create and delete divisions</p>
            </div>

            <!-- Alert Container -->
            <div id="alertContainer" class="mt-3" style="display: none;">
                <div class="alert alert-dismissible fade show" role="alert">
                    <span id="alertMessage"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">
                        <span>📊</span> Divisions Data
                    </h3>
                    <button class="btn btn-success btn-sm" onclick="showCreateDivisionModal()">
                        <i class="fas fa-plus"></i> Create Division
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="tablesDataTable" class="table table-striped table-bordered" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Division Name</th>
                                    <th>Created By</th>
                                    <th>Created Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CREATE DIVISION MODAL -->
    <div class="modal fade" id="createDivisionModal" tabindex="-1" aria-labelledby="createDivisionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="createDivisionForm">
                    <!-- CSRF token removed -->
                    <div class="modal-header">
                        <h5 class="modal-title" id="createDivisionModalLabel">
                            <i class="fas fa-plus-circle"></i> Create New Division
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Alert Container inside Modal -->
                        <div id="modalAlertContainer" class="mb-3" style="display: none;">
                            <div class="alert alert-dismissible fade show" role="alert">
                                <span id="modalAlertMessage"></span>
                                <button type="button" class="btn-close" onclick="hideModalAlert()" aria-label="Close"></button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="division_name" class="form-label">Division Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="division_name" name="division_name" required maxlength="100" placeholder="Enter division name">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">
                        <i class="fas fa-exclamation-triangle text-danger"></i> Delete Division
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Alert Container inside Delete Modal -->
                    <div id="deleteModalAlertContainer" class="mb-3" style="display: none;">
                        <div class="alert alert-dismissible fade show" role="alert">
                            <span id="deleteModalAlertMessage"></span>
                            <button type="button" class="btn-close" onclick="hideDeleteModalAlert()" aria-label="Close"></button>
                        </div>
                    </div>
                    
                    <p>Are you sure you want to delete this division?</p>
                    <p><strong>Division:</strong> <span id="deleteDivisionName"></span></p>
                    <input type="hidden" id="deleteDivisionId">
                    <p class="text-danger"><small><i class="fas fa-exclamation-triangle"></i> This action cannot be undone.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteDivision()">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let dataTable = null;

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            initializeDataTables();
            loadExistingDivisions();
        });

        // Initialize DataTables
        function initializeDataTables() {
            if (!document.getElementById('tablesDataTable')) {
                console.error('tablesDataTable element not found');
                return;
            }

            // Destroy existing DataTable if it exists
            if ($.fn.DataTable.isDataTable('#tablesDataTable')) {
                $('#tablesDataTable').DataTable().destroy();
            }

            try {
                dataTable = $('#tablesDataTable').DataTable({
                    pageLength: 10,
                    order: [[2, 'desc']], // Sort by created date descending
                    responsive: true,
                    columnDefs: [
                        { 
                            targets: [3], // Actions column
                            orderable: false,
                            searchable: false,
                            width: '150px'
                        }
                    ],
                    language: {
                        emptyTable: "Tidak ada divisi yang ditemukan",
                        processing: "Memuat divisi...",
                        search: "Cari divisi:",
                        lengthMenu: "Tampilkan _MENU_ divisi per halaman",
                        info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ divisi",
                        paginate: {
                            first: "Pertama",
                            last: "Terakhir",
                            next: "Selanjutnya", 
                            previous: "Sebelumnya"
                        }
                    }
                });
                
                console.log('DataTable initialized successfully');
            } catch (error) {
                console.error('DataTables initialization failed:', error);
            }
        }

        // Show create division modal
        function showCreateDivisionModal() {
            const modal = new bootstrap.Modal(document.getElementById('createDivisionModal'));
            document.getElementById('createDivisionForm').reset();
            hideModalAlert(); // Hide any existing alerts in modal
            modal.show();
        }

        // Show delete confirmation modal
        function deleteDivision(id, name) {
            document.getElementById('deleteDivisionId').value = id;
            document.getElementById('deleteDivisionName').textContent = name;
            hideDeleteModalAlert(); // Hide any existing alerts in modal
            
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }

        // Show alert inside modal
        function showModalAlert(type, message) {
            const alertContainer = document.getElementById('modalAlertContainer');
            const alertMessage = document.getElementById('modalAlertMessage');
            const alertElement = alertContainer.querySelector('.alert');
            
            // Remove existing alert classes
            alertElement.classList.remove('alert-success', 'alert-danger', 'alert-warning');
            
            // Add appropriate alert class
            const alertClass = type === 'success' ? 'alert-success' : type === 'warning' ? 'alert-warning' : 'alert-danger';
            alertElement.classList.add(alertClass);
            
            // Set message with icon
            const alertIcon = type === 'success' ? '✅' : type === 'warning' ? '⚠️' : '❌';
            alertMessage.innerHTML = `${alertIcon} ${message}`;
            
            // Show alert
            alertContainer.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideModalAlert();
            }, 5000);
        }

        // Hide modal alert
        function hideModalAlert() {
            const alertContainer = document.getElementById('modalAlertContainer');
            alertContainer.style.display = 'none';
        }

        // Show alert inside delete modal
        function showDeleteModalAlert(type, message) {
            const alertContainer = document.getElementById('deleteModalAlertContainer');
            const alertMessage = document.getElementById('deleteModalAlertMessage');
            const alertElement = alertContainer.querySelector('.alert');
            
            // Remove existing alert classes
            alertElement.classList.remove('alert-success', 'alert-danger', 'alert-warning');
            
            // Add appropriate alert class
            const alertClass = type === 'success' ? 'alert-success' : type === 'warning' ? 'alert-warning' : 'alert-danger';
            alertElement.classList.add(alertClass);
            
            // Set message with icon
            const alertIcon = type === 'success' ? '✅' : type === 'warning' ? '⚠️' : '❌';
            alertMessage.innerHTML = `${alertIcon} ${message}`;
            
            // Show alert
            alertContainer.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideDeleteModalAlert();
            }, 5000);
        }

        // Hide delete modal alert
        function hideDeleteModalAlert() {
            const alertContainer = document.getElementById('deleteModalAlertContainer');
            alertContainer.style.display = 'none';
        }

        // Handle create division form submission
        document.getElementById('createDivisionForm').addEventListener('submit', function (e) {
            e.preventDefault();
            
            const divisionName = document.getElementById('division_name').value.trim();
            if (!divisionName) {
                showModalAlert('error', 'Nama divisi harus diisi');
                return;
            }

            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Membuat...';

            // Hide any existing alerts
            hideModalAlert();

            fetch('/divisions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ division_name: divisionName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide create modal
                    bootstrap.Modal.getInstance(document.getElementById('createDivisionModal')).hide();
                    
                    // Show success modal instead of flash alert
                    showSuccessModal(divisionName, 'Division');
                    
                    // Reload divisions list
                    setTimeout(() => {
                        loadExistingDivisions();
                    }, 500);
                } else {
                    // Show error message inside modal
                    showModalAlert('error', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showModalAlert('error', 'Terjadi kesalahan saat membuat divisi');
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-save"></i> Create';
            });
        });

        // Confirm delete division
        function confirmDeleteDivision() {
            const divisionId = document.getElementById('deleteDivisionId').value;
            const divisionName = document.getElementById('deleteDivisionName').textContent;
            
            if (!divisionId) return;

            const deleteButton = document.querySelector('#deleteConfirmModal .btn-danger');
            deleteButton.disabled = true;
            deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menghapus...';

            // Hide any existing alerts
            hideDeleteModalAlert();

            fetch(`/divisions/${divisionId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide delete modal
                    bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
                    
                    // Show success modal
                    showSuccessModal(divisionName, 'Division', 'deleted');
                    
                    // Reload divisions list
                    setTimeout(() => {
                        loadExistingDivisions();
                    }, 500);
                } else {
                    // Show error message inside modal
                    showDeleteModalAlert('error', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showDeleteModalAlert('error', 'Terjadi kesalahan saat menghapus divisi');
            })
            .finally(() => {
                deleteButton.disabled = false;
                deleteButton.innerHTML = '<i class="fas fa-trash"></i> Delete';
            });
        }

        // Load existing divisions
        function loadExistingDivisions() {
            console.log('Loading existing divisions...');
            
            fetch('/divisions')
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data);
                
                if (data.success) {
                    if (data.divisions && data.divisions.length > 0) {
                        console.log(`Found ${data.divisions.length} divisions`);
                        populateTable(data.divisions);
                    } else {
                        console.log('No divisions found');
                        if (dataTable) {
                            dataTable.clear().draw();
                        }
                    }
                } else {
                    console.error('Failed to load divisions:', data.message);
                    showAlert('error', 'Gagal memuat divisi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error loading divisions:', error);
                showAlert('error', 'Error memuat divisi: ' + error.message);
            });
        }

        // Populate table with divisions data
        function populateTable(divisions) {
            console.log('Populating DataTable with divisions:', divisions);
            
            if (!dataTable) {
                console.error('dataTable is not initialized');
                initializeDataTables();
                return;
            }

            // Clear existing data
            dataTable.clear();

            if (!divisions || divisions.length === 0) {
                console.log('No divisions to populate');
                dataTable.draw();
                return;
            }

            // Add new data
            divisions.forEach((div, index) => {
                console.log(`Adding division ${index + 1}:`, div);
                
                const actionButton = `
                    <button class="btn btn-danger btn-sm" onclick="deleteDivision(${div.id}, '${div.division_name.replace(/'/g, "\\'")}')">
                        Delete
                    </button>
                `;

                try {
                    dataTable.row.add([
                        div.division_name || 'N/A',
                        div.created_by || 'N/A',
                        div.created_date || 'N/A',
                        actionButton
                    ]);
                } catch (error) {
                    console.error(`Error adding row ${index}:`, error);
                }
            });

            // Redraw the table
            dataTable.draw();
            console.log('DataTable populated and drawn');
        }

        // Show alert messages (for main page alerts)
        function showAlert(type, message) {
            // Remove existing alerts
            $('.alert').remove();
            
            const alertClass = type === 'success' ? 'alert-success' : type === 'warning' ? 'alert-warning' : 'alert-danger';
            const alertIcon = type === 'success' ? '✅' : type === 'warning' ? '⚠️' : '❌';
            
            const alert = $(`
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${alertIcon} ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            // Insert alert at the top of the main content
            $('.main-content').prepend(alert);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alert.alert('close');
            }, 5000);
        }

        function showSuccessModal(itemName, itemType, action = 'created') {
            // Create success modal if it doesn't exist
            let successModal = document.getElementById('successModal');
            if (!successModal) {
                createSuccessModal();
                successModal = document.getElementById('successModal');
            }
            
            // Update modal content
            const modalMessage = document.getElementById('successModalMessage');
            const actionText = action === 'deleted' ? 'deleted and verified successfully' : 'created and verified successfully';
            modalMessage.innerHTML = `${itemType} <strong>${itemName}</strong> ${actionText}`;
            
            // Show the modal
            const modal = new bootstrap.Modal(successModal);
            modal.show();
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                modal.hide();
            }, 3000);
        }

        // Create success modal HTML
        function createSuccessModal() {
            const modalHTML = `
                <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title" id="successModalLabel">
                                    <i class="fas fa-check-circle"></i> Success
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                                </div>
                                <p id="successModalMessage" class="fs-5"></p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Append to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Handle modal close events
        document.getElementById('createDivisionModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('createDivisionForm').reset();
            hideModalAlert(); // Hide alerts when modal closes
        });

        document.getElementById('deleteConfirmModal').addEventListener('hidden.bs.modal', function () {
            hideDeleteModalAlert(); // Hide alerts when modal closes
        });
    </script>
{% endblock %}