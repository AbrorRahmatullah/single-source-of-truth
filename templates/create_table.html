{% extends "header.html" %}

{% block title %}Create Template{% endblock %}

{% block content %}
    <!-- Sidebar -->
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Content -->
        <div class="content">
            <div class="content-header">
                <h2 class="content-title">Create Database Template</h2>
                <p class="content-subtitle">Create new templates in SQL Server database with custom columns and data types</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üóÉÔ∏è</span>
                        Template Management
                    </h3>
                </div>
                <div class="card-body">
                    <div class="info-box">
                        <h3>‚ÑπÔ∏è Informasi Penting</h3>
                            Kolom ID (Primary Key) akan otomatis ditambahkan
                    </div>

                    <form id="createTableForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="grid-container">
                            <div class="form-group position-relative">
                                <label for="table_name" class="form-label">Nama Template</label>
                                <div class="input-group">
                                    <input type="text" id="table_name" name="table_name" class="form-control"
                                        placeholder="Contoh: employee_data, customer_template" required>
                                    <span id="tableNameCheckValidation" class="input-group-text bg-transparent border-0" 
                                        style="font-size: 1.2rem;"></span>
                                </div>
                                <div class="form-text">
                                    Nama Template tidak boleh menggunakan spasi dan harus dimulai dengan huruf dan hanya boleh mengandung huruf, angka, dan underscore
                                </div>
                                <div id="tableNameCheck" class="form-text"></div>
                            </div>
                            <div class="form-group">
                                <label for="column_count" class="form-label">Jumlah Kolom</label>
                                <input type="number" id="column_count" name="column_count" class="form-control" 
                                    min="1" max="50" placeholder="Masukkan jumlah kolom minimal 1" required>
                                <div id="columnCountError" class="form-text text-danger" style="display: none;">
                                    ‚ö†Ô∏è Jumlah kolom tidak boleh kurang dari 1
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="divisions" class="form-label">Divisi</label>
                                {% if session.role_access == 'admin' %}
                                    <select id="divisions" name="divisions" class="form-control form-select" required>
                                        <option value="">-- Pilih Divisi --</option>
                                        {% for division in divisions %}
                                        <option value="{{ division }}">{{division}}</option>
                                        {% endfor %}
                                    </select>
                                {% else %}
                                    <input type="text" id="divisions" name="divisions" class="form-control" value="{{ session.division }}" readonly>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="button" id="createTemplateBtn" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#createTemplateModal" disabled>
                                <span>‚ûï</span> Create Template
                            </button>
                        </div>
                    </form>

                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Membuat template...</p>
                    </div>

                    <div class="result" id="result">
                        <div class="result-title" id="resultTitle"></div>
                        <div id="resultMessage"></div>
                        <div class="result-details" id="resultDetails"></div>
                    </div>

                    <div class="analysis-result" id="previewResult">
                        <h4>üìã Preview Query SQL</h4>
                        <div id="previewContent"></div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üìä</span>
                        Existing Templates
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="tablesDataTable" class="table table-striped table-bordered" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Template Name</th>
                                    <th>Division</th> <!-- ubah dari Column Count -->
                                    <th>Create Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailTemplateModal" tabindex="-1" aria-labelledby="detailTemplateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailTemplateModalLabel">
                        <i class="fas fa-info-circle"></i> Template Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="templateDetailsContent">
                        <!-- Content will be populated dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createTemplateModal" tabindex="-1" aria-labelledby="createTemplateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTemplateModalLabel">Tambah Kolom Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Info:</strong> Template akan dibuat dengan <span id="templateColumnCount"></span> kolom sesuai dengan input "Jumlah Kolom"
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered" id="templateColumnsTable">
                        <thead>
                        <tr>
                            <th>Column Name</th>
                            <th>Data Type</th>
                            <th>Allow Nulls</th>
                            <th>Default Value</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Baris kolom akan ditambahkan secara dinamis -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-success" onclick="saveTemplateColumns()">Simpan Template</button>
            </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editTableModal" tabindex="-1" aria-labelledby="editTableModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTableModalLabel">
                        <i class="fas fa-edit"></i> Edit Template
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editTableForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" id="edit_table_id" name="table_id">
                        <div class="mb-3">
                            <label for="edit_table_name" class="form-label">Template Name</label>
                            <input type="text" class="form-control" id="edit_table_name" name="table_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Columns</label>
                            <div id="editColumnsContainer">
                                <!-- Columns will be populated dynamically -->
                            </div>
                            <button type="button" class="btn btn-success btn-sm mt-2" onclick="addEditColumn()">
                                <i class="fas fa-plus"></i> Add Column
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTableChanges()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">
                        <i class="fas fa-exclamation-triangle text-danger"></i> Confirm Deletion
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this template?</p>
                    <p><strong>Template Name:</strong> <span id="deleteTableName"></span></p>
                    <p class="text-danger"><small><i class="fas fa-warning"></i> This action cannot be undone!</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables Scripts -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let columnCount = 0;
        let dataTypes = [];
        let isSubmitting = false;
        let tableCheckTimeout;
        let tablesDataTable;
        let editColumnCount = 0;
        let currentTableToDelete = null;
        let isTableNameAvailable = false;

        $(document).ready(function() {
            console.log('DOM ready - initializing...');
            
            // Initialize DataTables first
            setTimeout(() => {
                initializeDataTables();
            }, 100);
            
            // Set up other event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Column count change event with validation
            $('#column_count').on('input', function() {
                const count = parseInt($(this).val());
                
                // If input is empty or invalid, treat as 0
                if (isNaN(count) || $(this).val().trim() === '') {
                    validateColumnCount(0);
                } else {
                    validateColumnCount(count);
                }
                validateCreateTemplateForm();
            });
            
            // Also validate on blur to catch edge cases
            $('#column_count').on('blur', function() {
                const count = parseInt($(this).val());
                if (isNaN(count) || count < 1) {
                    $(this).val(''); // Clear invalid input
                    validateColumnCount(0);
                    validateCreateTemplateForm();
                }
            });
            
            // Table name validation
            $('#table_name').on('input', function() {
                validateTableName($(this).val());
                validateCreateTemplateForm();
            });
            
            // Division change validation
            $('#divisions').on('change', function() {
                validateCreateTemplateForm();
            });
        }

        function validateColumnCount(count) {
            const errorDiv = $('#columnCountError');
            const input = $('#column_count');
            
            // Check if count is less than 1 or NaN
            if (count < 1 || isNaN(count) || count === 0) {
                errorDiv.show().text('‚ö†Ô∏è Jumlah kolom tidak boleh kurang dari 1');
                input.addClass('is-invalid');
                return false;
            } else {
                errorDiv.hide();
                input.removeClass('is-invalid');
                if (count > 0) {
                    updateTemplateColumnCount(count);
                }
                return true;
            }
        }

        function updateTemplateColumnCount(count) {
            $('#templateColumnCount').text(count);
            
            const tbody = $('#templateColumnsTable tbody');
            tbody.empty();
            
            // Get data types if not already loaded
            if (dataTypes.length === 0) {
                loadDataTypes();
            }
            
            // Add rows for each column
            for (let i = 0; i < count; i++) {
                addTemplateColumnRow(tbody, i + 1);
            }
        }

        function validateTableName(tableName) {
            const checkElement = $('#tableNameCheck');

            if (!tableName) {
                checkElement.text('').removeClass('text-success text-danger');
                $('#createTemplateBtn').prop('disabled', true);
                return;
            }

            if (/\s/.test(tableName)) {
                checkElement.html('<span class="text-danger">‚ùå Tidak diperbolehkan menggunakan spasi dalam penamaan template</span>');
                $('#createTemplateBtn').prop('disabled', true);
                validateCreateTemplateForm();
                return;
            }

            if (!/^[a-zA-Z][a-zA-Z0-9_]*$/.test(tableName)) {
                checkElement.html('<span class="text-danger">‚ùå Format tidak valid (harus diawali huruf, hanya huruf/angka/underscore)</span>');
                $('#createTemplateBtn').prop('disabled', true);
                validateCreateTemplateForm();
                return;
            }

            if (/ssot_/i.test(tableName)) {
                checkElement.html('<span class="text-danger">‚ùå Nama template tidak boleh mengandung kata "ssot_"</span>');
                $('#createTemplateBtn').prop('disabled', true);
                validateCreateTemplateForm();
                return;
            }

            if (tableCheckTimeout) {
                clearTimeout(tableCheckTimeout);
            }

            tableCheckTimeout = setTimeout(() => {
                checkTableExists(tableName);
            }, 500);

            validateCreateTemplateForm();
        }

        function addTemplateColumnRow(tbody, index) {
            const row = $(`
                <tr>
                    <td>
                        <input type="text" class="form-control form-control-sm column-name-input" 
                            placeholder="column_name_${index}" required data-index="${index}">
                        <div class="column-name-error text-danger" style="display: none; font-size: 0.8em;">
                            ‚ùå Nama kolom tidak boleh menggunakan spasi
                        </div>
                    </td>
                    <td>
                        <select class="form-select" onchange="toggleDefaultValue(this)">
                            <option value="VARCHAR(255)">VARCHAR(255)</option>
                            <option value="INT">INT</option>
                            <option value="DATETIME">DATETIME</option>
                            <option value="NUMERIC(36,2)">NUMERIC(36,2)</option>
                            <option value="DECIMAL(10,2)">DECIMAL(10,2)</option>
                            <option value="TEXT">TEXT</option>
                            <option value="BIT">BIT</option>
                            <option value="DATE">DATE</option>
                            <option value="TIME(7)">TIME</option>
                            <option value="FLOAT">FLOAT</option>
                        </select>
                    </td>
                    <td>
                        <div class="form-check">
                            <input class="form-check-input allow-null-checkbox" type="checkbox" id="null_${index}" 
                                onchange="toggleDefaultValueBasedOnNull(this)">
                            <label class="form-check-label" for="null_${index}">Allow NULL</label>
                        </div>
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm default-value-input" 
                            placeholder="Default value (required)" required>
                        <div class="default-value-error text-danger" style="display: none; font-size: 0.8em;">
                            ‚ùå Default value wajib diisi jika Allow NULL tidak dicentang
                        </div>
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeTemplateRow(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `);
            
            tbody.append(row);

            // Add validation for column name (no spaces)
            row.find('.column-name-input').on('input', function() {
                validateColumnNameSpacing(this);
                validateSaveTemplateButton();
            });
            
            // Add validation for default value requirement
            row.find('.default-value-input').on('input', function() {
                validateDefaultValue(this);
                validateSaveTemplateButton();
            });
        }

        function validateColumnNameSpacing(input) {
            const value = $(input).val();
            const errorDiv = $(input).siblings('.column-name-error');
            
            if (value.includes(' ')) {
                errorDiv.show();
                $(input).addClass('is-invalid');
                return false;
            } else {
                errorDiv.hide();
                $(input).removeClass('is-invalid');
                return true;
            }
        }

        // Toggle default value berdasarkan Allow NULL
        function toggleDefaultValueBasedOnNull(checkbox) {
            const row = $(checkbox).closest('tr');
            const defaultValueInput = row.find('.default-value-input');
            const defaultValueError = row.find('.default-value-error');
            
            if ($(checkbox).is(':checked')) {
                // Allow NULL dicentang - default value tidak wajib dan bisa dikosongkan
                defaultValueInput.prop('required', false);
                defaultValueInput.prop('disabled', true);
                defaultValueInput.val('');
                defaultValueInput.attr('placeholder', 'Not required (NULL allowed)');
                defaultValueError.hide();
                defaultValueInput.removeClass('is-invalid');
            } else {
                // Allow NULL tidak dicentang - default value wajib diisi
                defaultValueInput.prop('required', true);
                defaultValueInput.prop('disabled', false);
                defaultValueInput.attr('placeholder', 'Default value (required)');
                validateDefaultValue(defaultValueInput[0]);
            }
            
            validateSaveTemplateButton();
        }

        // Validasi default value
        function validateDefaultValue(input) {
            const row = $(input).closest('tr');
            const allowNullCheckbox = row.find('.allow-null-checkbox');
            const errorDiv = row.find('.default-value-error');
            const value = $(input).val().trim();
            
            // Jika Allow NULL dicentang, tidak perlu validasi
            if (allowNullCheckbox.is(':checked')) {
                errorDiv.hide();
                $(input).removeClass('is-invalid');
                return true;
            }
            
            // Jika Allow NULL tidak dicentang, default value wajib diisi
            if (!value) {
                errorDiv.show();
                $(input).addClass('is-invalid');
                return false;
            } else {
                errorDiv.hide();
                $(input).removeClass('is-invalid');
                return true;
            }
        }

        // Validasi tombol Save Template
        function validateSaveTemplateButton() {
            const rows = $('#templateColumnsTable tbody tr');
            const columnNames = new Set();
            let hasDuplicate = false;
            let isValid = true;

            rows.each(function () {
                const columnName = $(this).find('.column-name-input').val().trim().toLowerCase();

                if (!columnName) {
                    isValid = false;
                    $(this).find('.column-name-error').show().text('‚ùå Nama kolom tidak boleh kosong');
                    $(this).find('.column-name-input').addClass('is-invalid');
                    return; // lanjut ke row berikutnya
                }

                if (columnNames.has(columnName)) {
                    hasDuplicate = true;
                    $(this).find('.column-name-error').show().text('‚ùå Nama kolom tidak boleh sama');
                    $(this).find('.column-name-input').addClass('is-invalid');
                } else {
                    columnNames.add(columnName);
                    $(this).find('.column-name-error').hide();
                    $(this).find('.column-name-input').removeClass('is-invalid');
                }
            });

            rows.each(function() {
                const columnNameInput = $(this).find('.column-name-input');
                const defaultValueInput = $(this).find('.default-value-input');
                const allowNullCheckbox = $(this).find('.allow-null-checkbox');

                // Validasi spasi/whitespace di nama kolom
                if (/\s/.test(columnNameInput.val())) {
                    isValid = false;
                    columnNameInput.addClass('is-invalid');
                    $(this).find('.column-name-error').show().text('‚ùå Nama kolom tidak boleh mengandung spasi');
                    return false; // hentikan loop jika ketemu error
                }

                // Validasi default value jika Allow NULL tidak dicentang
                if (!allowNullCheckbox.is(':checked') && !defaultValueInput.val().trim()) {
                    isValid = false;
                    defaultValueInput.addClass('is-invalid');
                    return false;
                } else {
                    defaultValueInput.removeClass('is-invalid');
                }
            });

            // Update tombol Save Template di modal
            const saveButton = $('.modal-footer button[onclick="saveTemplateColumns()"]');
            if (isValid && !hasDuplicate) {
                saveButton.prop('disabled', false)
                        .removeClass('btn-secondary')
                        .addClass('btn-success');
            } else {
                saveButton.prop('disabled', true)
                        .removeClass('btn-success')
                        .addClass('btn-secondary');
            }
        }

        // Fungsi untuk menampilkan detail template
        function viewTemplateDetails(tableName) {
            // Show loading state
            $('#detailTemplateModalLabel').html('<i class="fas fa-spinner fa-spin"></i> Loading Details...');
            $('#templateDetailsContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('detailTemplateModal'));
            modal.show();
            
            // Fetch template details
            fetch(`/get-template-details/${encodeURIComponent(tableName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayTemplateDetails(data.template);
                    } else {
                        $('#templateDetailsContent').html(`
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> Error: ${data.message}
                            </div>
                        `);
                    }
                })
                .catch(error => {
                    console.error('Error loading template details:', error);
                    $('#templateDetailsContent').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> Failed to load template details
                        </div>
                    `);
                })
                .finally(() => {
                    $('#detailTemplateModalLabel').html('<i class="fas fa-info-circle"></i> Template Details');
                });
        }

        // Fungsi untuk menampilkan detail template
        function displayTemplateDetails(template) {
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-info"></i> Template Information</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Template Name:</strong></td>
                                        <td>${template.name}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Division:</strong></td>
                                        <td>${template.division || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total Columns:</strong></td>
                                        <td><span class="badge bg-primary">${template.columns.length}</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Created Date:</strong></td>
                                        <td>${template.create_date || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Created By:</strong></td>
                                        <td>${template.created_by || 'N/A'}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-columns"></i> Column Details</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Column Name</th>
                                                <th>Data Type</th>
                                                <th>Allow Nulls</th>
                                                <th>Default Value</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${template.columns.map((col, index) => `
                                                <tr ${col.is_identity ? 'class="table-info"' : ''}>
                                                    <td>${index + 1}</td>
                                                    <td>
                                                        <strong>${col.name}</strong>
                                                        ${col.is_identity ? '<span class="badge bg-info ms-1">PK</span>' : ''}
                                                        ${col.name === 'period_date' || col.name === 'upload_date' ? '<span class="badge bg-success ms-1">Auto</span>' : ''}
                                                    </td>
                                                    <td>
                                                        <code>${col.data_type}${col.max_length && col.max_length !== -1 ? `(${col.max_length})` : ''}</code>
                                                    </td>
                                                    <td>
                                                        ${col.is_nullable ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}
                                                    </td>
                                                    <td>
                                                        ${col.default_value ? `<code>${col.default_value}</code>` : '<span class="text-muted">None</span>'}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('#templateDetailsContent').html(content);
        }

        function removeTemplateRow(button) {
            $(button).closest('tr').remove();
        }

        function validateCreateTemplateForm() {
            const tableName = document.getElementById('table_name').value.trim();
            const columnCountInput = document.getElementById('column_count');
            const columnCount = parseInt(columnCountInput.value);
            const divisions = document.getElementById('divisions').value;
            
            const createTemplateBtn = document.getElementById('createTemplateBtn');

            const hasSpace = /\s/.test(tableName);
            const invalidFormat = !/^[a-zA-Z][a-zA-Z0-9_]*$/.test(tableName);
            const containsSsot = /ssot_/i.test(tableName);

            const isTableNameValid = tableName.length > 0 && !hasSpace && !invalidFormat && !containsSsot && isTableNameAvailable;
            const isColumnCountValid = columnCount >= 1 && !isNaN(columnCount);
            const isDivisionValid = divisions.length > 0;

            if (isTableNameValid && isColumnCountValid && isDivisionValid) {
                createTemplateBtn.disabled = false;
                createTemplateBtn.classList.remove('btn-secondary');
                createTemplateBtn.classList.add('btn-success');
            } else {
                createTemplateBtn.disabled = true;
                createTemplateBtn.classList.remove('btn-success');
                createTemplateBtn.classList.add('btn-secondary');
            }
        }



        function saveTemplateColumns() {
            const tableName = document.getElementById('table_name').value.trim();
            const division = document.getElementById('divisions').value;
            const rows = document.querySelectorAll('#templateColumnsTable tbody tr');
            const columns = [];

            if (!tableName) {
                showAlert('error', 'Nama template harus diisi');
                return;
            }

            if (!division) {
                showAlert('error', 'Divisi harus dipilih');
                return;
            }

            let hasValidationError = false;
            let errorMessage = '';

            rows.forEach((row, index) => {
                const name = row.cells[0].querySelector('input').value.trim();
                const type = row.cells[1].querySelector('select').value;
                const allowNulls = row.cells[2].querySelector('input').checked;
                const defaultValue = row.cells[3].querySelector('input').value.trim();
                
                if (name && type) {
                    // Validasi nama kolom tidak boleh ada spasi
                    if (name.includes(' ')) {
                        hasValidationError = true;
                        errorMessage = `Nama kolom "${name}" tidak boleh menggunakan spasi`;
                        return;
                    }
                    
                    // Validasi default value jika Allow NULL tidak dicentang
                    if (!allowNulls && !defaultValue) {
                        hasValidationError = true;
                        errorMessage = `Default value wajib diisi untuk kolom "${name}" karena Allow NULL tidak dicentang`;
                        return;
                    }
                    
                    columns.push({ 
                        name, 
                        type, 
                        allow_nulls: allowNulls,
                        default_value: allowNulls ? null : (defaultValue || null)
                    });
                }
            });

            if (hasValidationError) {
                showAlert('error', errorMessage);
                return;
            }

            if (columns.length === 0) {
                showAlert('error', 'Minimal harus ada satu kolom yang valid');
                return;
            }

            const templateData = {
                table_name: tableName,
                columns: columns,
                divisions: division
            };

            fetch('/create-table', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(templateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide the create template modal first
                    const createModal = bootstrap.Modal.getInstance(document.getElementById('createTemplateModal'));
                    if (createModal) {
                        createModal.hide();
                    }
                    
                    // Wait for modal to be completely hidden before showing success
                    setTimeout(() => {
                        // Use simple alert instead of modal for better UX
                        showSuccessAlert(data.table_name || tableName);
                        
                        // Reset form
                        document.getElementById('createTableForm').reset();
                        document.getElementById('tableNameCheck').innerHTML = '';
                        validateCreateTemplateForm();
                        
                        // Reload tables
                        setTimeout(() => {
                            loadExistingTables();
                        }, 500);
                    }, 300);

                    cleanupAllModals();
                } else {
                    showAlert('error', data.message);
                }
            })
            .catch(error => {
                console.error('Error saving template:', error);
                showAlert('error', 'Terjadi kesalahan saat menyimpan template');
            });
        }

        function showSuccessAlert(tableName) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.success-alert');
            existingAlerts.forEach(alert => alert.remove());

            const alertHTML = `
                <div class="alert alert-success alert-dismissible fade show success-alert" 
                    role="alert" 
                    style="
                        position: fixed; 
                        top: 20px; 
                        right: 20px; 
                        z-index: 9999; 
                        min-width: 300px;
                        background-color: #d1e7dd;   /* Bootstrap's alert-success bg */
                        color: #0f5132;              /* Text color */
                        border-color: #badbcc;       /* Border color */
                    ">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-2" style="font-size: 1.5rem;"></i>
                        <div>
                            <strong>Success!</strong><br>
                            Template <strong>${tableName}</strong> created successfully
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', alertHTML);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                const alert = document.querySelector('.success-alert');
                if (alert) {
                    const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                    bsAlert.close();
                }
            }, 5000);
        }


        function toggleDefaultValue(element) {
            const row = element.closest('tr');
            const allowNullsCheckbox = row.querySelector('input[type="checkbox"]');
            const defaultValueInput = row.querySelector('.default-value-input');
            
            if (allowNullsCheckbox && defaultValueInput) {
                if (allowNullsCheckbox.checked) {
                    // Allow Nulls is checked - hide default value
                    defaultValueInput.style.display = 'none';
                    defaultValueInput.value = '';
                } else {
                    // Allow Nulls is unchecked - show default value
                    defaultValueInput.style.display = 'block';
                }
            }
        }

        function addTemplateRowWithData(columnNumber = null) {
            const tableBody = document.querySelector('#templateColumnsTable tbody');
            const row = document.createElement('tr');
            
            const columnName = columnNumber ? `column_${columnNumber}` : '';
            
            row.innerHTML = `
            <td><input type="text" class="form-control" placeholder="column_name" value="${columnName}"></td>
            <td>
                <select class="form-select" onchange="toggleDefaultValue(this)">
                    <option value="VARCHAR(255)">VARCHAR(255)</option>
                    <option value="INT">INT</option>
                    <option value="DATETIME">DATETIME</option>
                    <option value="NUMERIC(36,2)">NUMERIC(36,2)</option>
                    <option value="DECIMAL(10,2)">DECIMAL(10,2)</option>
                    <option value="TEXT">TEXT</option>
                    <option value="BIT">BIT</option>
                    <option value="DATE">DATE</option>
                    <option value="TIME(7)">TIME</option>
                    <option value="FLOAT">FLOAT</option>
                </select>
            </td>
            <td class="text-center">
                <input type="checkbox" class="form-check-input" checked onchange="toggleDefaultValue(this)">
            </td>
            <td class="text-center">
                <input type="text" class="form-control default-value-input" placeholder="Default value" style="display: none;">
            </td>
            <td class="text-center">
                <button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">üóëÔ∏è</button>
            </td>
            `;
            
            tableBody.appendChild(row);
        }

        function initializeTemplateModal() {
            const columnCount = parseInt(document.getElementById('column_count').value);
            const tableBody = document.querySelector('#templateColumnsTable tbody');
            
            // Clear existing rows
            tableBody.innerHTML = '';
            
            // Add rows sesuai jumlah kolom
            for (let i = 1; i <= columnCount; i++) {
                addTemplateRowWithData(i);
            }
        }

        // Load data types when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - secondary initialization...');
            
            // Wait a bit longer to ensure all elements are rendered
            setTimeout(() => {
                // Check if DataTable is already initialized
                if (!tablesDataTable) {
                    console.log('DataTable not initialized, trying again...');
                    initializeDataTables();
                }
                
                // Load other components
                loadDataTypes();
                addTooltips();
                addKeyboardShortcuts();
            }, 500);
        });

        // Load available SQL data types
        function loadDataTypes() {
            dataTypes = [
                'VARCHAR', 'NVARCHAR', 'CHAR', 'NCHAR',
                'INT', 'BIGINT', 'SMALLINT', 'TINYINT',
                'DECIMAL', 'NUMERIC', 'FLOAT', 'REAL',
                'DATE', 'DATETIME', 'DATETIME2', 'TIME',
                'BIT', 'TEXT', 'NTEXT'
            ];
        }

        // Check if table name exists
        function checkTableExists(tableName) {
            fetch(`/check-table-exists/${encodeURIComponent(tableName)}`)
                .then(response => response.json())
                .then(data => {
                    const checkElement = $('#tableNameCheckValidation');
                    if (data.exists) {
                        isTableNameAvailable = false;
                        checkElement.text('‚ùå')
                                    .removeClass('text-success')
                                    .addClass('text-danger');
                        $('#createTemplateBtn').prop('disabled', true)
                                            .removeClass('btn-success')
                                            .addClass('btn-secondary');
                    } else {
                        isTableNameAvailable = true;
                        checkElement.text('‚úÖ')
                                    .removeClass('text-danger')
                                    .addClass('text-success');
                        validateCreateTemplateForm();
                    }
                })
                .catch(error => {
                    console.error('Error checking table:', error);
                    isTableNameAvailable = false;
                    $('#tableNameCheckValidation')
                        .text('‚ö†Ô∏è')
                        .removeClass('text-success text-danger')
                        .addClass('text-warning');
                    $('#createTemplateBtn').prop('disabled', true)
                                        .removeClass('btn-success')
                                        .addClass('btn-secondary');
                });
        }


        function checkTableExistsBeforeSubmit(tableName) {
            return fetch(`/check-table-exists/${tableName}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        return result.exists;
                    }
                    throw new Error('Could not check table existence');
                });
        }

        // Add table name validation - UNIFIED VERSION
        /* function initializeTableNameValidation() {
            const tableNameInput = document.getElementById('table_name');
            if (!tableNameInput) return;

            tableNameInput.addEventListener('input', function(e) {
                const tableName = e.target.value.trim();
                
                // Clear previous timeout
                clearTimeout(tableCheckTimeout);
                
                // Validate table name format
                const validFormat = /^[a-zA-Z][a-zA-Z0-9_]*$/.test(tableName);
                const checkDiv = document.getElementById('tableNameCheckValidation');
                
                if (tableName.length === 0) {
                    checkDiv.innerHTML = '';
                    return;
                }
                
                // Show checking status
                checkDiv.innerHTML = '<span style="color: #6b7280;">üîç</span>';
                
                // Debounce the API call
                tableCheckTimeout = setTimeout(() => {
                    checkTableExists(tableName);
                }, 500);
            });
        } */

        // Initialize table name validation when DOM is loaded
        // document.addEventListener('DOMContentLoaded', initializeTableNameValidation);

        function removeColumn(id) {
            const columnDiv = document.getElementById(`column_${id}`);
            if (columnDiv) {
                columnDiv.remove();
            }
            
            // Renumber remaining columns
            const remainingColumns = document.querySelectorAll('.column-item');
            remainingColumns.forEach((col, index) => {
                const header = col.querySelector('.column-header h5');
                if (header) {
                    header.textContent = `Kolom ${index + 1}`;
                }
            });
        }

        function toggleLengthField(columnId) {
            const typeSelect = document.querySelector(`select[name="column_type_${columnId}"]`);
            const lengthInput = document.querySelector(`input[name="column_length_${columnId}"]`);
            
            if (typeSelect && lengthInput) {
                const selectedOption = typeSelect.options[typeSelect.selectedIndex];
                const hasLength = selectedOption.getAttribute('data-has-length') === 'true';
                
                lengthInput.disabled = !hasLength;
                lengthInput.required = hasLength;
                
                if (!hasLength) {
                    lengthInput.value = '';
                }
            }
        }

        // Utility function to validate column names
        function validateColumnName(name) {
            const validFormat = /^[a-zA-Z][a-zA-Z0-9_]*$/.test(name);
            const reservedWords = [
                'id', 'table', 'select', 'insert', 'update', 'delete', 'from', 'where', 
                'order', 'by', 'group', 'having', 'join', 'left', 'right', 'inner', 
                'outer', 'union', 'distinct', 'count', 'sum', 'avg', 'max', 'min',
                'database', 'schema', 'index', 'primary', 'foreign', 'key', 'constraint',
                'alter', 'drop', 'create', 'null', 'not', 'and', 'or', 'like', 'in',
                'exists', 'between', 'case', 'when', 'then', 'else', 'end'
            ];
            
            return {
                isValid: validFormat && !reservedWords.includes(name.toLowerCase()),
                message: !validFormat ? 
                    'Nama kolom harus dimulai dengan huruf dan hanya boleh mengandung huruf, angka, dan underscore' :
                    reservedWords.includes(name.toLowerCase()) ? 
                    'Nama kolom tidak boleh menggunakan kata kunci SQL yang sudah ada' : ''
            };
        }

        // Add real-time validation for column names - IMPROVED VERSION
        function addColumnNameValidation(columnId) {
            const nameInput = document.querySelector(`input[name="column_name_${columnId}"]`);
            if (!nameInput || nameInput.hasAttribute('data-validated')) {
                return;
            }
            
            nameInput.setAttribute('data-validated', 'true');
            
            nameInput.addEventListener('input', function(e) {
                const value = e.target.value.trim();
                const validation = validateColumnName(value);
                
                // Remove existing validation message
                const existingMessage = nameInput.parentNode.querySelector('.validation-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                if (value && !validation.isValid) {
                    const message = document.createElement('div');
                    message.className = 'validation-message';
                    message.style.cssText = 'color: #dc2626; font-size: 0.875rem; margin-top: 5px;';
                    message.textContent = '‚ùå ' + validation.message;
                    nameInput.parentNode.appendChild(message);
                }
            });
        }

        function previewTable() {
            const formData = getFormData();
            
            if (!formData.table_name) {
                showAlert('warning', 'Masukkan nama template terlebih dahulu');
                return;
            }
            
            if (formData.columns.length === 0) {
                showAlert('warning', 'Tambahkan minimal satu kolom');
                return;
            }
            
            // Generate preview query
            let query = `CREATE TABLE [${formData.table_name}] (\n`;
            query += `    [id] INT IDENTITY(1,1) PRIMARY KEY,\n`;
            
            const columnDefs = formData.columns.map(col => {
                let def = `    [${col.name}] ${col.type}`;
                
                if (col.length && ['VARCHAR', 'NVARCHAR', 'CHAR', 'NCHAR', 'VARBINARY', 'BINARY'].includes(col.type)) {
                    def += `(${col.length})`;
                } else if (col.length && ['DECIMAL', 'NUMERIC'].includes(col.type)) {
                    def += `(${col.length})`;
                }
                
                def += col.allow_nulls ? ' NULL' : ' NOT NULL';
                return def;
            });
            
            query += columnDefs.join(',\n');
            query += '\n)';
            
            // Show preview
            const previewDiv = document.getElementById('previewResult');
            const previewContent = document.getElementById('previewContent');
            
            previewContent.innerHTML = `
                <div class="preview-info">
                    <h5>üóÉÔ∏è Template: ${formData.table_name}</h5>
                    <p>Total kolom: ${formData.columns.length + 1} (termasuk ID)</p>
                </div>
                <div class="query-preview">
                    <h6>SQL Query:</h6>
                    <pre><code>${query}</code></pre>
                </div>
                <div class="columns-preview">
                    <h6>Struktur Kolom:</h6>
                    <table style="width: 100%; margin-top: 10px;">
                        <thead>
                            <tr>
                                <th>Nama Kolom</th>
                                <th>Tipe Data</th>
                                <th>Panjang</th>
                                <th>Allow Nulls</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: #f0f9ff;">
                                <td><strong>id</strong></td>
                                <td>INT IDENTITY(1,1)</td>
                                <td>-</td>
                                <td>‚ùå</td>
                            </tr>
                            ${formData.columns.map(col => `
                                <tr>
                                    <td><strong>${col.name}</strong></td>
                                    <td>${col.type}${col.length ? `(${col.length})` : ''}</td>
                                    <td>${col.length || '-'}</td>
                                    <td>${col.allow_nulls ? '‚úÖ' : '‚ùå'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            previewDiv.style.display = 'block';
            previewDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function getFormData() {
            const tableName = document.getElementById('table_name').value.trim();
            const columns = [];
            
            const columnItems = document.querySelectorAll('.column-item');
            columnItems.forEach(item => {
                const nameInput = item.querySelector('input[name^="column_name_"]');
                const typeSelect = item.querySelector('select[name^="column_type_"]');
                const lengthInput = item.querySelector('input[name^="column_length_"]');
                const nullableInput = item.querySelector('input[name^="column_nullable_"]');
                
                if (nameInput && typeSelect && nameInput.value.trim() && typeSelect.value) {
                    columns.push({
                        name: nameInput.value.trim(),
                        type: typeSelect.value,
                        length: lengthInput ? lengthInput.value.trim() : '',
                        allow_nulls: nullableInput ? nullableInput.checked : false
                    });
                }
            });
            
            return {
                table_name: tableName,
                columns: columns
            };
        }

        // Enhanced form validation
        function validateForm(formData) {
            const errors = [];

            // Table name validation
            if (!formData.table_name) {
                errors.push('Nama template harus diisi');
            } else {
                const tableValidation = /^[a-zA-Z][a-zA-Z0-9_]*$/.test(formData.table_name);
                if (!tableValidation) {
                    errors.push('Nama template tidak valid (harus dimulai huruf, hanya huruf/angka/underscore)');
                }
                if (/ssot_/i.test(formData.table_name)) {
                    errors.push('Nama template tidak boleh mengandung kata "ssot_"');
                }
            }

            // Columns validation
            if (formData.columns.length === 0) {
                errors.push('Minimal harus ada satu kolom');
            }

            // Column names validation
            const columnNames = [];
            const reservedColumns = ['id', 'period_date', 'upload_date'];

            formData.columns.forEach((col, index) => {
                if (!col.name) {
                    errors.push(`Nama kolom ${index + 1} harus diisi`);
                } else {
                    const validFormat = /^[a-zA-Z][a-zA-Z0-9_]*$/.test(col.name);
                    if (!validFormat) {
                        errors.push(`Nama kolom "${col.name}" tidak valid (hanya huruf, angka, underscore dan harus diawali huruf)`);
                    }

                    if (reservedColumns.includes(col.name.toLowerCase())) {
                        errors.push(`Kolom "${col.name}" tidak boleh digunakan karena sudah otomatis ditambahkan`);
                    }

                    if (columnNames.includes(col.name.toLowerCase())) {
                        errors.push(`Nama kolom duplikat: ${col.name}`);
                    }

                    columnNames.push(col.name.toLowerCase());
                }

                if (!col.type) {
                    errors.push(`Tipe data kolom ${index + 1} harus dipilih`);
                }

                // Validate length for specific data types
                if (col.type && ['VARCHAR', 'NVARCHAR', 'CHAR', 'NCHAR'].includes(col.type)) {
                    if (!col.length || parseInt(col.length) < 1 || parseInt(col.length) > 8000) {
                        errors.push(`Panjang kolom "${col.name}" harus antara 1-8000`);
                    }
                }

                if (col.type && ['DECIMAL', 'NUMERIC'].includes(col.type)) {
                    if (!col.length) {
                        errors.push(`Precision kolom "${col.name}" harus diisi`);
                    } else {
                        const parts = col.length.split(',');
                        const precision = parseInt(parts[0]);
                        const scale = parts[1] ? parseInt(parts[1]) : 0;

                        if (precision < 1 || precision > 38) {
                            errors.push(`Precision kolom "${col.name}" harus antara 1-38`);
                        }
                        if (scale < 0 || scale > precision) {
                            errors.push(`Scale kolom "${col.name}" harus antara 0-${precision}`);
                        }
                    }
                }
            });

            return errors;
        }

        // UNIFIED Form submission handler
        function initializeFormSubmission() {
            const form = document.getElementById('createTableForm');
            if (!form) return;

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Prevent double submission
                if (isSubmitting) {
                    showAlert('warning', 'Sedang memproses, harap tunggu...');
                    return;
                }
                
                const formData = getFormData();
                const validationErrors = validateForm(formData);
                
                if (validationErrors.length > 0) {
                    showAlert('error', validationErrors[0]);
                    return;
                }
                
                // Check table exists before submitting
                checkTableExistsBeforeSubmit(formData.table_name)
                    .then(exists => {
                        if (exists) {
                            showAlert('error', `Template "${formData.table_name}" sudah ada dalam database`);
                            return;
                        }
                        
                        // Proceed with submission
                        submitForm(formData);
                    })
                    .catch(error => {
                        console.warn('Could not check table existence, proceeding with submission');
                        submitForm(formData);
                    });
            });

            // Auto-save functionality
            form.addEventListener('input', function() {
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(saveDraft, 2000);
            });

            // Auto-save every 30 seconds
            setInterval(saveDraft, 30000);
        }

        // Initialize form submission when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeFormSubmission);

        function submitForm(formData) {
            isSubmitting = true;
            showLoading(true, 'Membuat template database...');
            hideResult();
            
            // Add timeout untuk request
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
            
            fetch('/create-table', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                showLoading(false);
                isSubmitting = false;
                
                if (data.success) {
                    const details = createSuccessDetails(data);
                    showResult('success', 'Template Berhasil Dibuat! üéâ', data.message, details);
                    
                    // Reset form
                    document.getElementById('createTableForm').reset();
                    document.getElementById('tableNameCheck').innerHTML = '';
                    columnCount = 0;
                    
                    // Reset button state
                    validateCreateTemplateForm();
                    
                    // Clear draft
                    clearDraft();
                    
                    // Show success alert
                    showAlert('success', `Template "${data.table_name}" berhasil dibuat!`);
                } else {
                    showResult('error', 'Gagal Membuat Template ‚ùå', data.message);
                    showAlert('error', data.message);
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                showLoading(false);
                isSubmitting = false;
                
                let errorMessage = 'Terjadi kesalahan tidak terduga';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timeout - silakan coba lagi';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showResult('error', 'Terjadi Kesalahan ‚ùå', errorMessage);
                showAlert('error', 'Terjadi kesalahan: ' + errorMessage);
            });
        }

        function createSuccessDetails(data) {
            let details = '<table style="width: 100%; margin-top: 15px;">';
            details += `<tr><th style="width: 40%;">Nama Template</th><td><strong>${data.table_name}</strong></td></tr>`;
            details += `<tr><th>Jumlah Kolom</th><td><strong>${data.columns_created + 1}</strong> (termasuk ID)</td></tr>`;
            details += '</table>';
            
            if (data.query) {
                details += '<div style="margin-top: 20px;">';
                details += '<h5 style="margin-bottom: 10px; color: #374151;">üìã Query SQL yang Dieksekusi:</h5>';
                details += `<pre style="background: #f8fafc; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 0.875rem;"><code>${data.query}</code></pre>`;
                details += '</div>';
            }
            
            return details;
        }

        function showLoading(show, message = 'Memproses...') {
            const loading = document.getElementById('loading');
            const loadingText = loading.querySelector('p');
            const submitButton = document.querySelector('button[type="submit"]');
            const previewButton = document.querySelector('button[onclick="previewTable()"]');
            
            if (show) {
                loading.style.display = 'block';
                loadingText.textContent = message;
                
                // Disable all buttons
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.style.opacity = '0.6';
                    submitButton.style.cursor = 'not-allowed';
                    submitButton.innerHTML = '<span>‚è≥</span> Membuat Template...';
                }
                
                if (previewButton) {
                    previewButton.disabled = true;
                    previewButton.style.opacity = '0.6';
                    previewButton.style.cursor = 'not-allowed';
                }
            } else {
                loading.style.display = 'none';
                
                // Re-enable buttons
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.style.opacity = '1';
                    submitButton.style.cursor = 'pointer';
                    submitButton.innerHTML = '<span>üóÉÔ∏è</span> Buat Template';
                }
                
                if (previewButton) {
                    previewButton.disabled = false;
                    previewButton.style.opacity = '1';
                    previewButton.style.cursor = 'pointer';
                }
            }
        }

        function showResult(type, title, message, details = '') {
            const result = document.getElementById('result');
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');
            const resultDetails = document.getElementById('resultDetails');
            
            result.className = `result ${type}`;
            result.style.display = 'block';
            resultTitle.innerHTML = title;
            resultMessage.innerHTML = message;
            resultDetails.innerHTML = details;
            
            result.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideResult() {
            const result = document.getElementById('result');
            const previewResult = document.getElementById('previewResult');
            result.style.display = 'none';
            previewResult.style.display = 'none';
        }

        function showAlert(type, message) {
            // Remove existing alerts
            $('.alert').remove();
            
            const alertClass = type === 'success' ? 'alert-success' : type === 'warning' ? 'alert-warning' : 'alert-danger';
            const alertIcon = type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
            
            const alert = $(`
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${alertIcon} ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            // Insert alert at the top of the main content
            $('.main-content').prepend(alert);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alert.alert('close');
            }, 5000);
        }

        function hideAlert() {
            const alert = document.getElementById('alert');
            if (alert) {
                alert.style.opacity = '0';
                alert.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }
        }

        // Add tooltips for better UX
        function addTooltips() {
            const tooltips = {
                'table_name': 'Nama template harus unik dan mengikuti aturan penamaan SQL Server',
                'column_type': 'Pilih tipe data yang sesuai dengan jenis data yang akan disimpan',
                'column_length': 'Panjang maksimum untuk tipe data yang mendukung panjang variabel'
            };
            
            Object.keys(tooltips).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.setAttribute('title', tooltips[id]);
                }
            });
        }

        // Add keyboard shortcuts
        function addKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + Enter to preview
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    previewTable();
                }
                
                // Ctrl/Cmd + Shift + Enter to submit
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Enter') {
                    e.preventDefault();
                    const form = document.getElementById('createTableForm');
                   if (form) {
                       form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                   }
               }
               
               // Ctrl/Cmd + S to save draft
               if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                   e.preventDefault();
                   saveDraft();
                   showAlert('info', 'Draft tersimpan');
               }
               
               // Escape to close modals and alerts
               if (e.key === 'Escape') {
                   hideAlert();
                   const modals = document.querySelectorAll('.modal.show');
                   modals.forEach(modal => {
                       const bsModal = bootstrap.Modal.getInstance(modal);
                       if (bsModal) bsModal.hide();
                   });
               }
           });
       }

        // Auto-save draft functionality (using sessionStorage for temporary storage)
        function saveDraft() {
           const formData = getFormData();
           const draft = {
               table_name: formData.table_name,
               columns: formData.columns,
               timestamp: new Date().toISOString()
           };
           
           // Save to memory instead of localStorage
           window.currentDraft = draft;
           
           // Visual feedback
           const draftIndicator = document.getElementById('draftIndicator');
           if (draftIndicator) {
               draftIndicator.style.display = 'inline';
               draftIndicator.textContent = 'üíæ Draft tersimpan';
               setTimeout(() => {
                   draftIndicator.style.display = 'none';
               }, 2000);
           }
        }

        function loadDraft() {
            const draft = window.currentDraft;
            if (!draft) return;
            
            // Load table name
            const tableNameInput = document.getElementById('table_name');
            if (tableNameInput && draft.table_name) {
                tableNameInput.value = draft.table_name;
            }
            
            // Load columns
            if (draft.columns && draft.columns.length > 0) {
                // Clear existing columns
                const columnsContainer = document.getElementById('columnsContainer');
                if (columnsContainer) {
                    columnsContainer.innerHTML = '';
                    
                    // Add columns from draft
                    draft.columns.forEach((col, index) => {
                        addColumn();
                        const columnDiv = document.querySelector(`#column_${columnCount}`);
                        if (columnDiv) {
                            const nameInput = columnDiv.querySelector('input[name^="column_name_"]');
                            const typeSelect = columnDiv.querySelector('select[name^="column_type_"]');
                            const lengthInput = columnDiv.querySelector('input[name^="column_length_"]');
                            const nullableInput = columnDiv.querySelector('input[name^="column_nullable_"]');
                            
                            if (nameInput) nameInput.value = col.name || '';
                            if (typeSelect) typeSelect.value = col.type || '';
                            if (lengthInput) lengthInput.value = col.length || '';
                            if (nullableInput) nullableInput.checked = col.allow_nulls || false;
                            
                            // Trigger validation
                            if (nameInput) addColumnNameValidation(columnCount);
                            if (typeSelect) toggleLengthField(columnCount);
                        }
                    });
                }
            }
            
            // Show draft loaded notification
            showAlert('info', `Draft dimuat (tersimpan: ${new Date(draft.timestamp).toLocaleString()})`);
        }

        function clearDraft() {
            window.currentDraft = null;
            const draftIndicator = document.getElementById('draftIndicator');
            if (draftIndicator) {
                draftIndicator.style.display = 'none';
            }
        }

        function cleanupAllModals() {
            // Remove all modal backdrops
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Remove modal-open class from body
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            // Dispose all modal instances
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                const instance = bootstrap.Modal.getInstance(modal);
                if (instance) {
                    instance.dispose();
                }
            });
        }

        function initializeDataTables() {
            if (!document.getElementById('tablesDataTable')) {
                console.error('tablesDataTable element not found');
                return;
            }

            // Destroy existing DataTable if it exists
            if ($.fn.DataTable.isDataTable('#tablesDataTable')) {
                $('#tablesDataTable').DataTable().destroy();
            }

            try {
                tablesDataTable = $('#tablesDataTable').DataTable({
                    responsive: true,
                    processing: true,
                    serverSide: false,
                    pageLength: 10,
                    order: [[2, 'desc']], // Sort by created date descending
                    columnDefs: [
                        { 
                            targets: [3], // Actions column
                            orderable: false,
                            searchable: false,
                            width: '150px'
                        }
                    ],
                    language: {
                        emptyTable: "Tidak ada template yang ditemukan",
                        processing: "Memuat template...",
                        search: "Cari template:",
                        lengthMenu: "Tampilkan _MENU_ template per halaman",
                        info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ template",
                        paginate: {
                            first: "Pertama",
                            last: "Terakhir", 
                            next: "Selanjutnya",
                            previous: "Sebelumnya"
                        }
                    }
                });
                
                console.log('DataTable initialized successfully');
                
                // Load data after DataTable is ready
                loadExistingTables();
                
            } catch (error) {
                console.error('DataTables initialization failed:', error);
            }
        }

        function loadExistingTables() {
            console.log('Loading existing tables...');
            
            fetch('/get-existing-tables')
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    
                    if (data.success) {
                        if (data.tables && data.tables.length > 0) {
                            console.log(`Found ${data.tables.length} templates`);
                            populateTablesDataTable(data.tables);
                        } else {
                            console.log('No templates found');
                            // Clear table if no data
                            if (tablesDataTable) {
                                tablesDataTable.clear().draw();
                            }
                        }
                    } else {
                        console.error('Failed to load templates:', data.message);
                        showAlert('error', 'Gagal memuat template: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading templates:', error);
                    showAlert('error', 'Error memuat template: ' + error.message);
                });
        }

        function populateTablesDataTable(tables) {
            console.log('Populating DataTable with tables:', tables);
            
            if (!tablesDataTable) {
                console.error('tablesDataTable is not initialized');
                initializeDataTables();
                return;
            }

            tablesDataTable.clear();
            
            if (!tables || tables.length === 0) {
                console.log('No tables to populate');
                tablesDataTable.draw();
                return;
            }
            
            tables.forEach((table, index) => {
                console.log(`Adding table ${index + 1}:`, table);
                
                const actions = `
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-info btn-sm" 
                                onclick="viewTemplateDetails('${table.name}')" 
                                title="View Details of ${table.name}">
                            Detail
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" 
                                onclick="deleteTable('${table.name}')" 
                                title="Delete ${table.name}">
                            Delete                        </button>
                    </div>
                `;
                
                try {
                    tablesDataTable.row.add([
                        table.name || 'N/A',
                        table.division || 'N/A',
                        table.create_date || 'N/A',
                        actions
                    ]);
                } catch (error) {
                    console.error(`Error adding row ${index}:`, error);
                }
            });
            
            tablesDataTable.draw();
            console.log('DataTable populated and drawn');
        }

        function editTable(tableName) {
            // Show loading state
            document.getElementById('editTableModalLabel').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            
            // Fetch table details
            fetch(`/get-table-details/${tableName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateEditModal(data.table);
                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('editTableModal'));
                        modal.show();
                    } else {
                        showAlert('error', 'Failed to load table details: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading table details:', error);
                    showAlert('error', 'Error loading table details');
                })
                .finally(() => {
                    document.getElementById('editTableModalLabel').innerHTML = '<i class="fas fa-edit"></i> Edit Table/Template';
                });
        }

        function populateEditModal(table) {
            document.getElementById('edit_table_id').value = table.name;
            document.getElementById('edit_table_name').value = table.name;
            
            // Clear existing columns
            const container = document.getElementById('editColumnsContainer');
            container.innerHTML = '';
            editColumnCount = 0;
            
            // Add existing columns
            if (table.columns && table.columns.length > 0) {
                const excludedColumns = ['period_date', 'upload_date', 'id'];
                table.columns
                    .filter(column => !excludedColumns.includes(column.name.toLowerCase()))
                    .forEach(column => {
                        addEditColumn(column);
                    });
            }
        }

        function addEditColumn() {
            editColumnCount++;
            const container = document.getElementById('editColumnsContainer');
            
            const columnDiv = document.createElement('div');
            columnDiv.className = 'row mb-2';
            columnDiv.innerHTML = `
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm" 
                        placeholder="Column Name" required>
                </div>
                <div class="col-md-3">
                    <select class="form-control form-control-sm" required>
                        <option value="">-- Type --</option>
                        <option value="VARCHAR">VARCHAR</option>
                        <option value="INT">INT</option>
                        <option value="DECIMAL">DECIMAL</option>
                        <option value="DATE">DATE</option>
                        <option value="DATETIME">DATETIME</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm" 
                        placeholder="Length">
                </div>
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox">
                        <label class="form-check-label">NULL</label>
                    </div>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger btn-sm" 
                            onclick="removeEditColumn(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(columnDiv);
        }

        function removeEditColumn(button) {
            button.closest('.row').remove();
        }

        function toggleEditLengthField(columnId) {
            const typeSelect = document.querySelector(`select[name="edit_column_type_${columnId}"]`);
            const lengthInput = document.querySelector(`input[name="edit_column_length_${columnId}"]`);
            
            if (typeSelect && lengthInput) {
                const selectedOption = typeSelect.options[typeSelect.selectedIndex];
                const hasLength = selectedOption.getAttribute('data-has-length') === 'true';
                
                lengthInput.disabled = !hasLength;
                lengthInput.required = hasLength;
                
                if (!hasLength) {
                    lengthInput.value = '';
                }
            }
        }

        function saveTableChanges() {
            const tableName = document.getElementById('edit_table_name').value.trim();
            const rows = document.querySelectorAll('#editColumnsContainer .row');
            const columns = [];

            if (!tableName) {
                showAlert('error', 'Nama template harus diisi');
                return;
            }

            rows.forEach(row => {
                const inputs = row.querySelectorAll('input, select');
                const name = inputs[0].value.trim();
                const type = inputs[1].value;
                const length = inputs[2].value.trim();
                const allowNulls = inputs[3].checked;

                if (!name || !type) return;

                const columnData = {
                    name: name,
                    type: type,
                    length: length || null,
                    allow_nulls: allowNulls
                };

                columns.push(columnData);
            });

            if (columns.length === 0) {
                showAlert('error', 'Minimal harus ada satu kolom yang valid untuk disimpan');
                return;
            }

            const payload = {
                table_name: tableName,
                columns: columns
            };

            fetch('/update-table', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', 'Perubahan template berhasil disimpan!');
                    loadExistingTables();

                    // Tutup modal jika ada
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editTableModal'));
                    if (modal) modal.hide();
                } else {
                    showAlert('error', 'Gagal menyimpan perubahan: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error updating table:', error);
                showAlert('error', 'Terjadi kesalahan saat menyimpan perubahan');
            });
        }


        function getEditFormData() {
            const tableName = document.getElementById('edit_table_name').value.trim();
            const originalTableName = document.getElementById('edit_table_id').value;
            const columns = [];
            
            const columnItems = document.querySelectorAll('.edit-column-item');
            columnItems.forEach(item => {
                const nameInput = item.querySelector('input[name^="edit_column_name_"]');
                const typeSelect = item.querySelector('select[name^="edit_column_type_"]');
                const lengthInput = item.querySelector('input[name^="edit_column_length_"]');
                const nullableInput = item.querySelector('input[name^="edit_column_nullable_"]');
                
                if (nameInput && typeSelect && nameInput.value.trim() && typeSelect.value) {
                    columns.push({
                        name: nameInput.value.trim(),
                        type: typeSelect.value,
                        length: lengthInput ? lengthInput.value.trim() : '',
                        nullable: nullableInput ? nullableInput.checked : false
                    });
                }
            });
            
            return {
                original_table_name: originalTableName,
                table_name: tableName,
                columns: columns
            };
        }

        function validateEditForm(formData) {
            if (!formData.table_name) {
                showAlert('error', 'Table name is required');
                return false;
            }
            
            if (formData.columns.length === 0) {
                showAlert('error', 'At least one column is required');
                return false;
            }
            
            // Additional validation logic can be added here
            return true;
        }

        function deleteTable(tableName) {
            currentTableToDelete = tableName;
            
            // Update modal content
            document.getElementById('deleteTableName').textContent = tableName;
            
            // Show confirmation modal
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }

        function confirmDelete() {
            if (!currentTableToDelete) {
                showAlert('error', 'No table selected for deletion');
                return;
            }
            
            fetch('/delete-table', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ table_name: currentTableToDelete })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    loadExistingTables(); // Reload the table list
                    
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                    modal.hide();
                } else {
                    showAlert('error', 'Gagal menghapus: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error deleting table:', error);
                showAlert('error', 'Terjadi kesalahan saat menghapus table');
            })
            .finally(() => {
                currentTableToDelete = null;
            });
        }

        // Auto-save every 30 seconds
        setInterval(saveDraft, 30000);

        // Refresh tables data periodically
        setInterval(loadExistingTables, 300000);

        // Save draft when form changes
        document.getElementById('createTableForm').addEventListener('input', function() {
            clearTimeout(this.saveTimeout);
            this.saveTimeout = setTimeout(saveDraft, 2000);
        });

    </script>
{% endblock %}