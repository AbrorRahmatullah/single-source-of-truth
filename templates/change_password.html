{% extends "header.html" %}

{% block title %}Change Password{% endblock %}

{% block content %}
<!-- Sidebar -->
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content">
        <div class="content">
            <div class="content-header">
                <h2 class="content-title">Change Password</h2>
                <p class="content-subtitle">Change a user password with appropriate permissions</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <div class="card-title-icon">üë§</div>
                        Change Password
                    </h3>
                </div>
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate onsubmit="return validatePassword(event)">
                        <div class="form-group">
                            <label for="current_password" class="form-label">Current Password:</label>
                            <input type="password" name="current_password" class="form-control password-input" id="current_password" placeholder="Enter your current password" required>
                            <div class="invalid-feedback">Please provide your current password.</div>
                        </div>

                        <div class="form-group">
                            <label for="new_password" class="form-label">New Password:</label>
                            <input type="password" name="new_password" class="form-control password-input" id="new_password" placeholder="Enter your new password" required oninput="checkPasswordStrength()">
                            <div class="password-requirements">
                                <p id="lengthCheck">‚ùå Minimal panjang 9 digit</p>
                                <p id="capitalCheck">‚ùå Mengandung huruf kapital</p>
                                <p id="numberCheck">‚ùå Mengandung angka</p>
                                <p id="specialCheck">‚ùå Mengandung karakter spesial</p>
                            </div>
                            <div class="invalid-feedback" id="new_password_error">Password tidak memenuhi syarat.</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="password_confirm" class="form-label">Confirm New Password:</label>
                            <div class="password-input-container">
                                <input type="password" name="password_confirm" class="form-control password-input" id="password_confirm" placeholder="Confirm your new password" required>
                            </div>
                            <div class="invalid-feedback" id="password_confirm_error">Passwords do not match.</div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                Submit
                            </button>
                            <a href="/upload" class="btn btn-secondary">
                                Back
                            </a>
                        </div>
                    </form>

                    {% with messages = get_flashed_messages() %}
                        {% if messages %}
                        <div class="alert alert-danger">
                            <div class="alert-icon">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                            <div class="alert-content">
                                {% for message in messages %}
                                    <p>{{ message }}</p>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>

    <!-- Load Bootstrap Icons -->
    <link rel="stylesheet" href="static/bootstrap-icons.css">

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        function togglePassword(inputId, icon) {
            var inputField = document.getElementById(inputId);
            
            if (inputField.type === "password") {
                inputField.type = "text";
                icon.classList.remove("bi-eye-slash");
                icon.classList.add("bi-eye");
            } else {
                inputField.type = "password";
                icon.classList.remove("bi-eye");
                icon.classList.add("bi-eye-slash");
            }
        }

        function checkPasswordStrength() {
            var password = document.getElementById("new_password").value;

            // Seleksi elemen validasi
            var lengthCheck = document.getElementById("lengthCheck");
            var capitalCheck = document.getElementById("capitalCheck");
            var numberCheck = document.getElementById("numberCheck");
            var specialCheck = document.getElementById("specialCheck");

            // Regex untuk validasi password
            var hasCapital = /[A-Z]/.test(password);
            var hasNumber = /\d/.test(password);
            var hasSpecial = /[@$!%*?&]/.test(password);
            var isLongEnough = password.length >= 9;

            // Update status validasi
            lengthCheck.innerHTML = isLongEnough ? "‚úÖ Minimal panjang 9 digit" : "‚ùå Minimal panjang 9 digit";
            capitalCheck.innerHTML = hasCapital ? "‚úÖ Mengandung huruf kapital" : "‚ùå Mengandung huruf kapital";
            numberCheck.innerHTML = hasNumber ? "‚úÖ Mengandung angka" : "‚ùå Mengandung angka";
            specialCheck.innerHTML = hasSpecial ? "‚úÖ Mengandung karakter spesial" : "‚ùå Mengandung karakter spesial";

            lengthCheck.className = isLongEnough ? "valid" : "invalid";
            capitalCheck.className = hasCapital ? "valid" : "invalid";
            numberCheck.className = hasNumber ? "valid" : "invalid";
            specialCheck.className = hasSpecial ? "valid" : "invalid";
        }

        function validatePassword(event) {
            event.preventDefault();

            var newPassword = document.getElementById("new_password").value;
            var confirmPassword = document.getElementById("password_confirm").value;
            var newPasswordError = document.getElementById("new_password_error");
            var confirmPasswordError = document.getElementById("password_confirm_error");
            var form = document.querySelector(".needs-validation");
            var isValid = true;

            // Validasi password
            var hasCapital = /[A-Z]/.test(newPassword);
            var hasNumber = /\d/.test(newPassword);
            var hasSpecial = /[@$!%*?&]/.test(newPassword);
            var isLongEnough = newPassword.length >= 9;

            if (!isLongEnough || !hasCapital || !hasNumber || !hasSpecial) {
                newPasswordError.style.display = "block";
                isValid = false;
            } else {
                newPasswordError.style.display = "none";
            }

            // Validasi konfirmasi password
            if (newPassword !== confirmPassword) {
                confirmPasswordError.style.display = "block";
                isValid = false;
            } else {
                confirmPasswordError.style.display = "none";
            }

            // Jika valid, submit form
            if (isValid) {
                form.submit();
            }
        }
    </script>
{% endblock %}
