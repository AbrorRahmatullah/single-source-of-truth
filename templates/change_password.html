{% extends "header.html" %}

{% block title %}Change Password{% endblock %}

{% block content %}
<!-- Sidebar -->
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="content">
            <div class="content-header">
                <h2 class="content-title">Change Password</h2>
                <p class="content-subtitle">Change a user password with appropriate permissions</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <div class="card-title-icon">üë§</div>
                        Change Password
                    </h3>
                </div>
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate onsubmit="return validatePassword(event)">
                        <!-- CSRF token removed -->
                        <div class="form-group">
                            <label for="current_password" class="form-label">Current Password:</label>
                            <input type="password" name="current_password" class="form-control password-input" 
                                id="current_password" placeholder="Enter your current password" 
                                value="{{ current_password or '' }}" required>
                            {% if error_current %}
                                <div class="error-message-password">{{ error_current }}</div>
                            {% endif %}
                            <div class="invalid-feedback">Please provide your current password.</div>
                        </div>

                        <div class="form-group">
                            <label for="new_password" class="form-label">New Password:</label>
                            <input type="password" name="new_password" class="form-control password-input" 
                                id="new_password" placeholder="Enter your new password" 
                                value="{{ new_password or '' }}" required oninput="checkPasswordStrength()">
                            <div class="password-requirements">
                                <p id="lengthCheck">‚ùå Minimal panjang 9 digit</p>
                                <p id="capitalCheck">‚ùå Mengandung huruf kapital</p>
                                <p id="numberCheck">‚ùå Mengandung angka</p>
                                <p id="specialCheck">‚ùå Mengandung karakter spesial</p>
                            </div>
                            {% if error_strength %}
                                <div class="error-message-password">{{ error_strength }}</div>
                            {% endif %}
                            <div class="invalid-feedback" id="new_password_error">Password tidak memenuhi syarat.</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="password_confirm" class="form-label">Confirm New Password:</label>
                            <div class="password-input-container">
                                <input type="password" name="password_confirm" class="form-control password-input" 
                                    id="password_confirm" placeholder="Confirm your new password" 
                                    value="{{ password_confirm or '' }}" required>
                            </div>
                            {% if error_confirm %}
                                <div class="error-message-password">{{ error_confirm }}</div>
                            {% endif %}
                            <div class="invalid-feedback" id="password_confirm_error">Passwords do not match.</div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                Submit
                            </button>
                            <a href="/upload" class="btn btn-secondary">
                                Back
                            </a>
                        </div>
                    </form>


                </div>
            </div>
        </div>
    </div>

    <!-- Load Bootstrap Icons -->
    <link rel="stylesheet" href="static/bootstrap-icons.css">

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        function togglePassword(inputId, icon) {
            var inputField = document.getElementById(inputId);
            
            if (inputField.type === "password") {
                inputField.type = "text";
                icon.classList.remove("bi-eye-slash");
                icon.classList.add("bi-eye");
            } else {
                inputField.type = "password";
                icon.classList.remove("bi-eye");
                icon.classList.add("bi-eye-slash");
            }
        }

        function checkPasswordStrength() {
            var password = document.getElementById("new_password").value;

            // Seleksi elemen validasi
            var lengthCheck = document.getElementById("lengthCheck");
            var capitalCheck = document.getElementById("capitalCheck");
            var numberCheck = document.getElementById("numberCheck");
            var specialCheck = document.getElementById("specialCheck");

            // Regex untuk validasi password
            var hasCapital = /[A-Z]/.test(password);
            var hasNumber = /\d/.test(password);
            var hasSpecial = /[@$!%*?&]/.test(password);
            var isLongEnough = password.length >= 9;

            // Update status validasi
            lengthCheck.innerHTML = isLongEnough ? "‚úÖ Minimal panjang 9 digit" : "‚ùå Minimal panjang 9 digit";
            capitalCheck.innerHTML = hasCapital ? "‚úÖ Mengandung huruf kapital" : "‚ùå Mengandung huruf kapital";
            numberCheck.innerHTML = hasNumber ? "‚úÖ Mengandung angka" : "‚ùå Mengandung angka";
            specialCheck.innerHTML = hasSpecial ? "‚úÖ Mengandung karakter spesial" : "‚ùå Mengandung karakter spesial";

            lengthCheck.className = isLongEnough ? "valid" : "invalid";
            capitalCheck.className = hasCapital ? "valid" : "invalid";
            numberCheck.className = hasNumber ? "valid" : "invalid";
            specialCheck.className = hasSpecial ? "valid" : "invalid";

            // Update button status
            updatePasswordSubmitButton();
        }

        function updatePasswordSubmitButton() {
            var password = document.getElementById("new_password").value;
            var confirmPassword = document.getElementById("password_confirm").value;
            var submitBtn = document.getElementById("submitBtn");
            
            // Check password strength
            var hasCapital = /[A-Z]/.test(password);
            var hasNumber = /\d/.test(password);
            var hasSpecial = /[@$!%*?&]/.test(password);
            var isLongEnough = password.length >= 9;
            var isPasswordStrong = hasCapital && hasNumber && hasSpecial && isLongEnough;
            
            // Check if passwords match
            var passwordsMatch = password === confirmPassword && password.length > 0;
            
            // Enable button only if password is strong and passwords match
            if (submitBtn) {
                submitBtn.disabled = !(isPasswordStrong && passwordsMatch);
            }
        }

        function validatePassword(event) {
            event.preventDefault();

            var currentPassword = document.getElementById("current_password").value;
            var newPasswordInput = document.getElementById("new_password");
            var newPassword = newPasswordInput.value;
            var confirmPasswordInput = document.getElementById("password_confirm");
            var confirmPassword = confirmPasswordInput.value;

            var newPasswordError = document.getElementById("new_password_error");
            var confirmPasswordError = document.getElementById("password_confirm_error");
            var form = document.querySelector(".needs-validation");
            var isValid = true;

            // Validasi current password tidak kosong
            if (!currentPassword.trim()) {
                isValid = false;
            }

            // Validasi password strength
            var hasCapital = /[A-Z]/.test(newPassword);
            var hasNumber = /\d/.test(newPassword);
            var hasSpecial = /[@$!%*?&]/.test(newPassword);
            var isLongEnough = newPassword.length >= 9;

            if (!isLongEnough || !hasCapital || !hasNumber || !hasSpecial) {
                newPasswordError.style.display = "block";
                newPasswordInput.classList.add("is-invalid");
                isValid = false;
            } else {
                newPasswordError.style.display = "none";
                newPasswordInput.classList.remove("is-invalid");
            }

            // Validasi konfirmasi password
            if (newPassword !== confirmPassword) {
                confirmPasswordError.style.display = "block";
                confirmPasswordInput.classList.add("is-invalid");
                isValid = false;
            } else {
                confirmPasswordError.style.display = "none";
                confirmPasswordInput.classList.remove("is-invalid");
            }

            // Jika valid, submit form
            if (isValid) {
                form.submit();
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            var newPasswordInput = document.getElementById("new_password");
            var confirmPasswordInput = document.getElementById("password_confirm");
            var confirmPasswordError = document.getElementById("password_confirm_error");

            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', function() {
                    checkPasswordStrength();
                    checkConfirmPasswordMatch();
                });
            }

            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', function() {
                    updatePasswordSubmitButton();
                    checkConfirmPasswordMatch();
                });
            }

            function checkConfirmPasswordMatch() {
                if (newPasswordInput.value !== confirmPasswordInput.value && confirmPasswordInput.value.length > 0) {
                    confirmPasswordError.style.display = "block";
                    confirmPasswordInput.classList.add("is-invalid");
                } else {
                    confirmPasswordError.style.display = "none";
                    confirmPasswordInput.classList.remove("is-invalid");
                }
            }

            // Initial check jika sudah ada nilai sebelumnya
            if (newPasswordInput.value || confirmPasswordInput.value) {
                checkConfirmPasswordMatch();
            }
        });
    </script>
{% endblock %}
