{% extends "header.html" %}

{% block title %}Upload Files{% endblock %}

{% block content %}
    <!-- Sidebar -->
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Content -->
        <div class="content">
            <div class="content-header">
                <h2 class="content-title">Excel File Upload</h2>
                <p class="content-subtitle">Upload and process your Excel files with template matching</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üìÅ</span>
                        File Upload Configuration
                    </h3>
                </div>
                <div class="card-body">
                    <div class="info-box">
                        <h3>‚ÑπÔ∏è Informasi Penting</h3>
                        <strong>Format File:</strong> Mendukung .xlsx dan .xls (maksimal 16MB)
                    </div>

                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="grid-container">
                            <div class="form-group">
                                <label for="table_name" class="form-label">Pilih template</label>
                                <select id="table_name" name="table_name" class="form-control form-select" required>
                                    <option value="">-- Pilih template --</option>
                                    {% for table in template_tables %}
                                    <option value="{{ table }}">{{ table|replace('_', ' ')|title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="file" class="form-label">Pilih File Excel</label>
                                <input type="file" id="file" name="file" class="form-control" accept=".xlsx,.xls" required>
                                <div class="form-text">Format: .xlsx atau .xls, maksimal 16MB</div>
                            </div>
                            <div class="form-group">
                                <label for="sheet_name" class="form-label">Pilih Sheet</label>
                                <select id="sheet_name" name="sheet_name" class="form-control form-select" disabled required>
                                    <option value="">-- Pilih file Excel terlebih dahulu --</option>
                                </select>
                                <div class="form-text">Pilih sheet yang akan diproses dari file Excel</div>
                            </div>
                            <div class="form-group">
                                <label for="periode_date" class="form-label">Period Date</label>
                                <input type="month" id="periode_date" name="periode_date" class="form-control" required>
                                <div class="form-text">Period Date diambil dari form input, tidak dari file Excel</div>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-info" onclick="analyzeFile()">
                                <span>üîç</span>
                                Analisis File
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="previewHeaders()">
                                <span>üëÅÔ∏è</span>
                                Preview Existing Data
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <span>üì§</span>
                                Upload & Insert Data
                            </button>
                            <!-- <button type="button" class="btn btn-danger" onclick="simulateValidationError()">
                                üß™ Test Validation Error
                            </button> -->
                        </div>
                    </form>

                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Memproses file Excel...</p>
                    </div>

                    <div class="result" id="result">
                        <div class="result-header">
                            <div class="result-title" id="resultTitle"></div>
                            <div class="result-subtitle"></div>
                        </div>
                        <div class="result-content">
                            <div class="status-indicator"></div>
                            <div class="result-message">
                                <div class="result-text" id="resultText"></div>
                            </div>
                            <div class="result-details" id="resultDetails"></div>
                        </div>
                        <div class="result-footer"></div>
                    </div>

                    <div class="analysis-result" id="analysisResult">
                        <h4>üìã Hasil Analisis File Excel</h4>
                        <div class="analysis-grid" id="analysisGrid"></div>
                        <div id="sampleDataContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Validation Error Modal -->
    <div id="validationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>üìã Validation Error Details</h4>
                <span class="close" onclick="closeValidationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="error-summary" id="errorSummary"></div>
                <ul class="error-list" id="errorList"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeValidationModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Test koneksi database saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            testConnection();
        });

        function testConnection() {
            // Simulasi test koneksi database
            console.log('Testing database connection...');
            
            // Show connection status in console
            setTimeout(() => {
                console.log('‚úÖ Database connection successful');
            }, 500);
        }

        function analyzeFile() {
            const fileInput = document.getElementById('file');
            const sheetSelect = document.getElementById('sheet_name');
            const file = fileInput.files[0];

            if (!file) {
                showAlert('error', 'Pilih file Excel terlebih dahulu');
                return;
            }

            // Validasi sheet selection
            if (!sheetSelect.value) {
                showAlert('warning', 'Pilih sheet yang akan dianalisis');
                sheetSelect.focus();
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('sheet_name', sheetSelect.value);

            showLoading(true, 'Menganalisis file Excel...');
            hideResult();

            fetch('/analyze-excel', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                if (result.success) {
                    showAnalysisResult(result.analysis);
                } else {
                    showAlert('error', result.message || 'Gagal menganalisis file.');
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('error', 'Terjadi kesalahan saat analisis: ' + error);
            });
        }

        function previewHeaders() {
            const tableSelect = document.getElementById('table_name');
            const tableName = tableSelect.value.trim();

            if (!tableName) {
                showAlert('warning', 'Pilih template terlebih dahulu');
                tableSelect.focus();
                return;
            }

            showLoading(true, 'Memuat header database...');
            hideResult();

            fetch(`/preview-headers/${tableName}`)
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                if (result.success) {
                    let headers = result.headers || {};
                    let headerEntries = Object.entries(headers);
                    
                    // Pisahkan kolom berdasarkan jenis
                    let excelColumns = [];
                    let automaticColumns = [];
                    
                    headerEntries.forEach(([name, info]) => {
                        if (info.is_automatic) {
                            automaticColumns.push([name, info]);
                        } else {
                            excelColumns.push([name, info]);
                        }
                    });

                    // Buat HTML untuk kolom Excel (yang harus ada di file)
                    let excelColumnsList = excelColumns.map(([name, info]) => {
                        let detail = `(${info.data_type}`;
                        if (info.max_length) detail += `, max ${info.max_length}`;
                        if (info.precision !== null && info.scale !== null) detail += `, precision ${info.precision}, scale ${info.scale}`;
                        detail += info.is_nullable ? ', nullable' : ', not null';
                        detail += ')';

                        return `
                            <li>
                                <span class="column-name">${name}</span>
                                <span class="column-details">${detail}</span>
                            </li>`;
                    }).join('');

                    // Buat HTML untuk kolom otomatis
                    let automaticColumnsList = automaticColumns.map(([name, info]) => {
                        let detail = `(${info.data_type}`;
                        if (info.max_length) detail += `, max ${info.max_length}`;
                        if (info.precision !== null && info.scale !== null) detail += `, precision ${info.precision}, scale ${info.scale}`;
                        detail += info.is_nullable ? ', nullable' : ', not null';
                        detail += ')';

                        let description = '';
                        if (name.toLowerCase() === 'id') {
                            description = ' - Auto increment primary key';
                        } else if (name.toLowerCase() === 'period_date') {
                            description = ' - Diisi dari form Periode Date';
                        } else if (name.toLowerCase() === 'upload_date') {
                            description = ' - Otomatis diisi saat upload';
                        }

                        return `
                            <li>
                                <span class="column-name">${name}</span>
                                <span class="column-details">${detail}${description}</span>
                                <span class="tag tag-auto">Auto</span>
                            </li>`;
                    }).join('');

                    let dataCountsHtml = '';
                    if (result.data_counts_by_period && result.data_counts_by_period.length > 0) {
                        let dataCountsList = result.data_counts_by_period.map(item => {
                        return `
                            <tr class="data-count-row">
                                <td class="period-date">${item.period_date}</td>
                                <td class="record-count">${item.total_records.toLocaleString()} rows</td>
                            </tr>`;
                    }).join('');

                    dataCountsHtml = `
                        <div class="info-card">
                            <div class="info-card-title">
                                <b>Data Existing (${result.data_counts_by_period.length} periode)</b>
                            </div>
                            <div class="table-wrapper">
                                <table class="data-count-table">
                                    <thead>
                                        <tr>
                                            <th>Period Date</th>
                                            <th>Total Records</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${dataCountsList}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                    }

                    // Buat konten lengkap dengan struktur yang sesuai
                    let details = `
                        ${dataCountsHtml}
                        <div class="info-card">
                            <div class="info-card-title">
                                <b>Kolom Yang Harus Ada di File Excel (${excelColumns.length} kolom)</b>
                            </div>
                            <ul class="info-list">
                                ${excelColumnsList}
                            </ul>
                        </div>`;

                    // Buat message content
                    let messageContent = `
                        <div class="result-text">
                            Template database berhasil dimuat. Silakan periksa struktur dan data pada kolom di bawah ini sebelum melakukan upload data.
                        </div>`;

                    showResult('success', `${tableName}`, messageContent, details);

                } else {
                    showAlert('error', result.message || 'Gagal memuat header.');
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('error', 'Terjadi kesalahan saat memuat header: ' + error.message);
            });
        }

        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const tableSelect = document.getElementById('table_name');
            const fileInput = document.getElementById('file');
            const sheetSelect = document.getElementById('sheet_name');
            const periodeDate = document.getElementById('periode_date');
            const file = fileInput.files[0];
            
            // Enhanced validation with user-friendly messages
            if (!tableSelect.value) {
                showAlert('warning', 'Pilih template database terlebih dahulu');
                tableSelect.focus();
                return;
            }
            
            if (!file) {
                showAlert('warning', 'Pilih file Excel yang akan diupload');
                fileInput.focus();
                return;
            }
            
            if (!sheetSelect.value) {
                showAlert('warning', 'Pilih sheet Excel yang akan diproses');
                sheetSelect.focus();
                return;
            }
            
            if (!periodeDate.value) {
                showAlert('warning', 'Tentukan periode date untuk data ini');
                periodeDate.focus();
                return;
            }
            
            if (!validateMonthYear(periodeDate.value)) {
                showAlert('error', 'Format periode tidak valid. Gunakan format YYYY-MM (contoh: 2024-01)');
                periodeDate.focus();
                return;
            }

            const formData = new FormData();
            formData.append('table_name', tableSelect.value);
            formData.append('primary_header', document.getElementById('primary_header')?.value || '');
            formData.append('file', file);
            formData.append('sheet_name', sheetSelect.value);
            formData.append('periode_date', periodeDate.value);

            // Check period existence first
            fetch('/check-period', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    table_name: tableSelect.value,
                    periode_date: periodeDate.value
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    if (result.exists) {
                        const confirmMessage = `‚ö†Ô∏è Data untuk periode ${periodeDate.value} sudah ada di tabel ${tableSelect.value}.\n\nApakah Anda yakin ingin mengganti data tersebut?\n\n‚ö†Ô∏è Perhatian: Data lama akan dihapus dan tidak dapat dikembalikan!`;
                        if (!confirm(confirmMessage)) {
                            showAlert('info', 'Proses upload dibatalkan oleh user.');
                            return;
                        }
                    }

                    // Proceed with upload
                    showLoading(true, 'Melakukan validasi struktur kolom dan memproses data...');
                    hideResult();

                    fetch('/upload', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        showLoading(false);
                        if (data.success) {
                            const details = createResultDetails(data);
                            let successMessage = 'File Excel berhasil divalidasi dan data telah dimasukkan ke database.';
                            
                            if (data.header_info && data.header_info.matched_columns !== undefined) {
                                const matchPercentage = Math.round((data.header_info.matched_columns / data.header_info.required_columns) * 100);
                                if (matchPercentage < 100) {
                                    successMessage += ` Sistem berhasil mencocokkan ${matchPercentage}% kolom dengan menggunakan strategi pencocokan lanjutan.`;
                                }
                            }
                            
                            showResult('success', 'Upload Berhasil! üéâ', successMessage, details);
                        } else {
                            // Enhanced error handling berdasarkan validation type
                            let errorTitle = '';
                            let errorMessage = data.message || 'Terjadi kesalahan saat memproses file Excel.';
                            let errorDetails = '';
                            
                            if (data.validation_type === 'column_structure') {
                                // errorTitle = 'Struktur Kolom Tidak Sesuai! üö´';
                                errorDetails = ''; // Details akan ditangani dalam showResult
                            } else if (data.validation_type === 'data_validation') {
                                errorTitle = 'Validasi Data Gagal! üö®';
                                errorDetails = createErrorDetails(data);
                            } else {
                                errorDetails = createErrorDetails(data);
                            }
                            
                            showResult('error', errorTitle, errorMessage, errorDetails, data);
                        }
                    })
                    .catch(error => {
                        showLoading(false);
                        console.error('Upload Error:', error);
                        showResult('error', 'Upload Gagal! ‚ùå', 
                            'Terjadi kesalahan jaringan saat mengupload file. Silakan periksa koneksi dan coba lagi.', '');
                    });

                } else {
                    showAlert('error', result.message || 'Gagal mengecek data periode.');
                }
            })
            .catch(error => {
                console.error('Period check error:', error);
                showAlert('error', 'Terjadi kesalahan saat mengecek data periode: ' + error.message);
            });
        });

        function createHeaderInfoDetails(headerInfo) {
            if (!headerInfo) return '';
            
            let details = '<div style="margin-top: 15px;"><h5 style="color: #374151; margin-bottom: 10px;">üìã File Processing Info:</h5>';
            details += '<table style="width: 100%; font-size: 0.875rem;">';
            
            if (headerInfo.sheet_used) {
                details += `<tr><td style="width: 40%; font-weight: 600;">Sheet Used:</td><td>${headerInfo.sheet_used}</td></tr>`;
            }
            if (headerInfo.header_row) {
                details += `<tr><td style="font-weight: 600;">Header Row:</td><td>${headerInfo.header_row}</td></tr>`;
            }
            if (headerInfo.data_start_row) {
                details += `<tr><td style="font-weight: 600;">Data Start Row:</td><td>${headerInfo.data_start_row}</td></tr>`;
            }
            if (headerInfo.detected_primary) {
                details += `<tr><td style="font-weight: 600;">Primary Header:</td><td>${headerInfo.detected_primary}</td></tr>`;
            }
            
            details += '</table></div>';
            return details;
        }

        function createColumnValidationErrorDetails(data) {
            if (!data.validation_type) return '';
            
            let details = '<div style="margin-top: 15px;">';
            
            if (data.validation_type === 'column_structure') {
                // details += '<h5 style="color: #dc2626; margin-bottom: 12px;">üö® Struktur Kolom Tidak Sesuai</h5>';
                
                // Show comparison table
                /* if (data.header_info && data.header_info.required_headers && data.header_info.excel_headers) {
                    const requiredHeaders = data.header_info.required_headers;
                    const excelHeaders = data.header_info.excel_headers;
                    
                    details += '<div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin-bottom: 15px;">';
                    details += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">';
                    
                    // Column count comparison
                    details += '<div style="text-align: center;">';
                    details += `<div style="font-size: 1.8rem; font-weight: bold; color: ${excelHeaders.length === requiredHeaders.length ? '#059669' : '#dc2626'};">${excelHeaders.length}</div>`;
                    details += '<div style="font-size: 0.875rem; color: #6b7280;">Kolom di Excel</div>';
                    details += '</div>';
                    
                    details += '<div style="text-align: center;">';
                    details += `<div style="font-size: 1.8rem; font-weight: bold; color: #374151;">${requiredHeaders.length}</div>`;
                    details += '<div style="font-size: 0.875rem; color: #6b7280;">Kolom Dibutuhkan</div>';
                    details += '</div>';
                    
                    details += '</div></div>';
                    
                    // Detailed column comparison
                    details += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">';
                    
                    // Excel columns
                    details += '<div>';
                    details += '<h6 style="color: #374151; margin-bottom: 8px; border-bottom: 2px solid #e5e7eb; padding-bottom: 4px;">üìÑ Kolom di File Excel</h6>';
                    details += '<div style="background: #f9fafb; border: 1px solid #d1d5db; border-radius: 6px; padding: 12px; max-height: 250px; overflow-y: auto;">';
                    
                    if (excelHeaders.length === 0) {
                        details += '<div style="color: #6b7280; font-style: italic; text-align: center; padding: 20px;">Tidak ada kolom ditemukan</div>';
                    } else {
                        excelHeaders.forEach((header, index) => {
                            const isMatched = requiredHeaders.some(req => req.toLowerCase() === header.toLowerCase() || req.toLowerCase() === header.replace(/\s+/g, '_').toLowerCase());
                            const statusIcon = isMatched ? '‚úÖ' : '‚ùå';
                            const statusColor = isMatched ? '#059669' : '#dc2626';
                            
                            details += `<div style="padding: 6px 0; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 8px;">`;
                            details += `<span style="color: ${statusColor}; font-weight: bold;">${statusIcon}</span>`;
                            // details += `<span style="color: #374151; font-size: 0.875rem;">${index + 1}. ${header || '(kosong)'}</span>`;
                            details += '</div>';
                        });
                    }
                    
                    details += '</div></div>';
                    
                    // Required columns
                    details += '<div>';
                    details += '<h6 style="color: #374151; margin-bottom: 8px; border-bottom: 2px solid #e5e7eb; padding-bottom: 4px;">üóÑÔ∏è Kolom Template Database</h6>';
                    details += '<div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px; padding: 12px; max-height: 250px; overflow-y: auto;">';
                    
                    requiredHeaders.forEach((header, index) => {
                        const isFound = excelHeaders.some(excel => excel.toLowerCase() === header.toLowerCase() || excel.replace(/\s+/g, '_').toLowerCase() === header.toLowerCase());
                        const statusIcon = isFound ? '‚úÖ' : '‚ùå';
                        const statusColor = isFound ? '#059669' : '#dc2626';
                        
                        details += `<div style="padding: 6px 0; border-bottom: 1px solid #bbf7d0; display: flex; align-items: center; gap: 8px;">`;
                        details += `<span style="color: ${statusColor}; font-weight: bold;">${statusIcon}</span>`;
                        details += `<span style="color: #374151; font-size: 0.875rem;">${index + 1}. ${header}</span>`;
                        details += '</div>';
                    });
                    
                    details += '</div></div>';
                    details += '</div>';
                } */
                
                // Enhanced suggestions for column structure issues
                const columnSuggestions = [
                    'Pastikan file Excel memiliki jumlah kolom yang sama persis dengan template yang telah ditentukan',
                    'Periksa nama kolom - harus sesuai dengan template (tidak case-sensitive)',
                    'Spasi dalam nama kolom akan dikonversi otomatis ke underscore (_)',
                    'Jangan ada kolom kosong atau tambahan yang tidak diperlukan',
                    'Gunakan tombol "Preview Header DB" untuk melihat struktur kolom yang dibutuhkan',
                    'Pastikan header berada di baris yang benar dan tidak ada baris kosong sebelumnya'
                ];
                
                details += '<div style="background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; padding: 16px; margin-top: 15px;">';
                details += '<h6 style="color: #1e40af; margin-bottom: 12px;">üí° Langkah Perbaikan:</h6>';
                details += '<ol style="margin: 0; padding-left: 20px; color: #1e40af; line-height: 1.8;">';
                columnSuggestions.forEach(suggestion => {
                    details += `<li style="margin-bottom: 8px;">${suggestion}</li>`;
                });
                details += '</ol>';
                details += '</div>';
                
            } else if (data.validation_type === 'data_validation') {
                // Handle data validation errors (existing logic)
                details += '<h5 style="color: #dc2626; margin-bottom: 12px;">üìä Validasi Data Gagal</h5>';
                
                if (data.validation_errors && data.total_errors) {
                    const errorPatterns = analyzeErrorPatterns(data.validation_errors);
                    
                    details += `<div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin-bottom: 15px;">`;
                    details += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; text-align: center;">`;
                    details += `<div><div style="font-size: 1.8rem; font-weight: bold; color: #dc2626;">${data.total_errors}</div><div style="font-size: 0.875rem; color: #6b7280;">Total Error</div></div>`;
                    details += `<div><div style="font-size: 1.8rem; font-weight: bold; color: #dc2626;">${data.rows_processed || 0}</div><div style="font-size: 0.875rem; color: #6b7280;">Baris Diproses</div></div>`;
                    details += `<div><div style="font-size: 1.8rem; font-weight: bold; color: #dc2626;">0</div><div style="font-size: 0.875rem; color: #6b7280;">Baris Berhasil</div></div>`;
                    details += `</div></div>`;
                    
                    details += '<div style="background: #fef2f2; padding: 12px; border-radius: 6px; margin: 12px 0;">';
                    details += '<h6 style="color: #dc2626; margin-bottom: 8px;">üîç Analisis Error:</h6>';
                    details += createErrorPatternSummary(errorPatterns);
                    details += '</div>';
                }
            }
            
            details += '</div>';
            return details;
        }

        function showLoading(show, message = 'Memproses file Excel...') {
            const loading = document.getElementById('loading');
            const loadingText = loading.querySelector('p');
            const buttons = document.querySelectorAll('.btn');
            
            if (show) {
                loading.style.display = 'block';
                loadingText.textContent = message;
                buttons.forEach(btn => btn.disabled = true);
                
                // Add loading animation to buttons
                buttons.forEach(btn => {
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                });
            } else {
                loading.style.display = 'none';
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });
            }
        }

        function showResult(type, title, message, details = '', data = null) {
            const result = document.getElementById('result');
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultText');
            const resultDetails = document.getElementById('resultDetails');
            
            result.className = `result ${type}`;
            result.style.display = 'block';
            resultTitle.innerHTML = title;
            
            // Enhanced error handling berdasarkan validation type
            if (type === 'error' && data) {
                if (data.validation_type === 'column_structure') {
                    // Column structure validation error
                    const columnErrorDetails = createColumnValidationErrorDetails(data);
                    
                    resultMessage.innerHTML = `
                        <div class="result-text">
                            <div style="background: #fef2f2; border-left: 4px solid #dc2626; padding: 16px; margin-bottom: 16px; border-radius: 0 8px 8px 0;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">üö´</span>
                                    <div>
                                        <h4 style="margin: 0; color: #dc2626;">Upload Gagal - Struktur Kolom Tidak Sesuai</h4>
                                        <p style="margin: 4px 0 0 0; color: #991b1b; font-size: 0.9rem;">File Excel tidak dapat diproses karena struktur kolom tidak sesuai dengan template yang telah ditentukan.</p>
                                    </div>
                                </div>
                                <div style="color: #dc2626; font-weight: 500;">
                                    ‚ö†Ô∏è Tidak ada data yang diinsert ke database. Perbaiki struktur kolom terlebih dahulu.
                                </div>
                            </div>
                            ${message}
                        </div>
                        ${columnErrorDetails}
                    `;
                } else if (data.validation_type === 'data_validation') {
                    // Data validation error (existing logic)
                    const totalErrors = data.total_errors || data.validation_errors.length;
                    const displayedErrors = Math.min(data.validation_errors.length, 5);
                    const errorPatterns = analyzeErrorPatterns(data.validation_errors);
                    
                    let errorSummary = `
                        <div class="validation-error-summary">
                            <div style="background: #fef2f2; border-left: 4px solid #dc2626; padding: 16px; margin-bottom: 16px; border-radius: 0 8px 8px 0;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">üö®</span>
                                    <div>
                                        <h4 style="margin: 0; color: #dc2626;">Upload Gagal - Validasi Data Error</h4>
                                        <p style="margin: 4px 0 0 0; color: #991b1b; font-size: 0.9rem;">Ditemukan ${totalErrors} error dalam data yang mengakibatkan gagal validasi.</p>
                                    </div>
                                </div>
                                <div style="color: #dc2626; font-weight: 500;">
                                    ‚ö†Ô∏è Seluruh operasi dibatalkan. Tidak ada data yang diinsert ke database.
                                </div>
                            </div>
                            
                            <div class="error-stats">
                                <div class="error-stat">
                                    <div class="error-stat-number">${totalErrors}</div>
                                    <div class="error-stat-label">Total Errors</div>
                                </div>
                                <div class="error-stat">
                                    <div class="error-stat-number">${data.rows_processed || 0}</div>
                                    <div class="error-stat-label">Rows Processed</div>
                                </div>
                                <div class="error-stat">
                                    <div class="error-stat-number">0</div>
                                    <div class="error-stat-label">Rows Inserted</div>
                                </div>
                            </div>
                            
                            <div style="background: #fef2f2; padding: 12px; border-radius: 6px; margin: 12px 0;">
                                <h6 style="color: #dc2626; margin-bottom: 8px;">üîç Error Analysis:</h6>
                                ${createErrorPatternSummary(errorPatterns)}
                            </div>
                    `;
                    
                    // Show sample errors
                    if (data.validation_errors.length > 0) {
                        errorSummary += '<h6 style="color: #374151; margin: 16px 0 8px 0;">Sample Errors:</h6>';
                        errorSummary += '<ul style="margin: 0; padding-left: 0; list-style: none;">';
                        
                        data.validation_errors.slice(0, displayedErrors).forEach((error, index) => {
                            const formattedError = formatErrorMessage(error);
                            errorSummary += `<li class="error-item">${formattedError}</li>`;
                        });
                        
                        errorSummary += '</ul>';
                        
                        if (totalErrors > displayedErrors) {
                            errorSummary += `
                                <div style="text-align: center; margin-top: 12px;">
                                    <button type="button" class="btn btn-secondary" onclick="showValidationModal(${JSON.stringify(data).replace(/"/g, '&quot;')})">
                                        View All ${totalErrors} Errors
                                    </button>
                                </div>
                            `;
                        }
                    }
                    
                    errorSummary += '</div>';
                    
                    resultMessage.innerHTML = `
                        <div class="result-text">${message}</div>
                        ${errorSummary}
                    `;
                } else {
                    // Generic error handling
                    resultMessage.innerHTML = `
                        <div class="result-text">
                            <div style="background: #fef2f2; border-left: 4px solid #dc2626; padding: 16px; margin-bottom: 16px; border-radius: 0 8px 8px 0;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="font-size: 1.5rem;">‚ùå</span>
                                    <div>
                                        <h4 style="margin: 0; color: #dc2626;">Upload Gagal</h4>
                                        <p style="margin: 4px 0 0 0; color: #991b1b; font-size: 0.9rem;">Terjadi kesalahan saat memproses file Excel.</p>
                                    </div>
                                </div>
                            </div>
                            ${message}
                        </div>
                    `;
                }
            } else {
                resultMessage.innerHTML = message;
            }
            
            // Set details based on validation type
            if (type === 'error' && data && data.validation_type === 'column_structure') {
                resultDetails.innerHTML = ''; // Details sudah included dalam message
            } else {
                resultDetails.innerHTML = details;
            }
            
            // Scroll to result
            result.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideResult() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('analysisResult').style.display = 'none';
        }

        function analyzeErrorPatterns(errors) {
            const patterns = {
                nullConstraint: 0,
                typeConversion: 0,
                lengthExceeded: 0,
                dateFormat: 0,
                numericFormat: 0,
                other: 0
            };
            
            errors.forEach(error => {
                const errorLower = error.toLowerCase();
                if (errorLower.includes('cannot be null') || errorLower.includes('null constraint')) {
                    patterns.nullConstraint++;
                } else if (errorLower.includes('invalid') && (errorLower.includes('integer') || errorLower.includes('numeric') || errorLower.includes('decimal'))) {
                    patterns.numericFormat++;
                } else if (errorLower.includes('invalid') && errorLower.includes('date')) {
                    patterns.dateFormat++;
                } else if (errorLower.includes('exceeds maximum length')) {
                    patterns.lengthExceeded++;
                } else if (errorLower.includes('type conversion') || errorLower.includes('invalid')) {
                    patterns.typeConversion++;
                } else {
                    patterns.other++;
                }
            });
            
            return patterns;
        }

        function createErrorPatternSummary(patterns) {
            const suggestions = [];
            let summary = '';
            
            if (patterns.nullConstraint > 0) {
                summary += `<div style="color: #dc2626; margin-bottom: 4px;">‚Ä¢ ${patterns.nullConstraint} NULL constraint violations</div>`;
                suggestions.push('Pastikan kolom wajib tidak kosong atau gunakan nilai default');
            }
            
            if (patterns.numericFormat > 0) {
                summary += `<div style="color: #dc2626; margin-bottom: 4px;">‚Ä¢ ${patterns.numericFormat} invalid numeric values</div>`;
                suggestions.push('Periksa format angka - hapus simbol mata uang, gunakan titik untuk desimal');
            }
            
            if (patterns.dateFormat > 0) {
                summary += `<div style="color: #dc2626; margin-bottom: 4px;">‚Ä¢ ${patterns.dateFormat} invalid date formats</div>`;
                suggestions.push('Gunakan format tanggal YYYY-MM-DD atau MM/DD/YYYY');
            }
            
            if (patterns.lengthExceeded > 0) {
                summary += `<div style="color: #dc2626; margin-bottom: 4px;">‚Ä¢ ${patterns.lengthExceeded} text length exceeded</div>`;
                suggestions.push('Singkat text yang terlalu panjang sesuai batas kolom database');
            }
            
            if (patterns.typeConversion > 0) {
                summary += `<div style="color: #dc2626; margin-bottom: 4px;">‚Ä¢ ${patterns.typeConversion} type conversion errors</div>`;
                suggestions.push('Pastikan tipe data sesuai dengan kolom database');
            }
            
            if (patterns.other > 0) {
                summary += `<div style="color: #dc2626; margin-bottom: 4px;">‚Ä¢ ${patterns.other} other validation errors</div>`;
            }
            
            if (suggestions.length > 0) {
                summary += '<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #fecaca;">';
                summary += '<div style="font-weight: 500; color: #374151; margin-bottom: 4px;">üí° Quick Fixes:</div>';
                suggestions.forEach(suggestion => {
                    summary += `<div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 2px;">- ${suggestion}</div>`;
                });
                summary += '</div>';
            }
            
            return summary;
        }

        function showAnalysisResult(analysis) {
            const analysisResult = document.getElementById('analysisResult');
            const analysisGrid = document.getElementById('analysisGrid');
            const sampleDataContainer = document.getElementById('sampleDataContainer');
            
            // Create analysis grid dengan info sheet
            analysisGrid.innerHTML = `
                <div class="analysis-item">
                    <div class="label">Sheet Digunakan</div>
                    <div class="value">${analysis.sheet_name || 'Sheet pertama'}</div>
                </div>
                <div class="analysis-item">
                    <div class="label">Total Baris</div>
                    <div class="value">${analysis.total_rows.toLocaleString()}</div>
                </div>
                <div class="analysis-item">
                    <div class="label">Total Kolom</div>
                    <div class="value">${analysis.total_columns}</div>
                </div>
                <div class="analysis-item">
                    <div class="label">Baris Header</div>
                    <div class="value">${analysis.header_row}</div>
                </div>
                <div class="analysis-item">
                    <div class="label">Baris Data Mulai</div>
                    <div class="value">${analysis.data_start_row}</div>
                </div>
                <div class="analysis-item">
                    <div class="label">Jumlah Data (baris)</div>
                    <div class="value">${analysis.data_rows_available.toLocaleString()}</div>
                </div>
            `;
            
            // Sisanya sama seperti sebelumnya...
            let sampleDataHtml = '<h4>üìÑ Preview Data (3 baris pertama)</h4>';
            if (analysis.sample_data && analysis.sample_data.length > 0) {
                sampleDataHtml += '<div class="sample-data"><table>';
                
                // Header row dengan numbering - skip empty headers
                sampleDataHtml += '<thead><tr><th style="width: 50px; text-align: center;">#</th>';
                analysis.headers.forEach(header => {
                    const isEmpty = !header || header.trim() === '';
                    // Skip empty columns completely
                    if (!isEmpty) {
                        sampleDataHtml += `<th title="${header}">${header}</th>`;
                    }
                });
                sampleDataHtml += '</tr></thead>';
                
                // Sample data rows dengan row numbers - skip empty columns
                sampleDataHtml += '<tbody>';
                analysis.sample_data.forEach((row, index) => {
                    sampleDataHtml += `<tr><td style="text-align: center; font-weight: 600; color: #6b7280;">${index + 1}</td>`;
                    row.forEach((cell, cellIndex) => {
                        // Only show data for non-empty header columns
                        const header = analysis.headers[cellIndex];
                        const headerIsEmpty = !header || header.trim() === '';
                        
                        if (!headerIsEmpty) {
                            const cellValue = cell || '';
                            const isNumber = !isNaN(cellValue) && cellValue !== '';
                            sampleDataHtml += `<td style="${isNumber ? 'text-align: right; font-family: monospace;' : ''}" title="${cellValue}">
                                ${cellValue.length > 20 ? cellValue.substring(0, 20) + '...' : cellValue}
                            </td>`;
                        }
                    });
                    sampleDataHtml += '</tr>';
                });
                sampleDataHtml += '</tbody></table></div>';
                
                // Add summary info - only count actual data columns
                const validHeaders = analysis.headers.filter(h => h && h.trim() !== '');
                const emptyHeaderCount = analysis.headers.filter(h => !h || h.trim() === '').length;
                
                sampleDataHtml += `
                    <div style="margin-top: 15px; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.875rem;">
                        <strong>üìä Ringkasan:</strong> Menampilkan ${Math.min(3, analysis.sample_data.length)} dari ${analysis.data_rows_available} baris data dengan ${validHeaders.length} kolom valid.
                        ${emptyHeaderCount > 0 ? 
                            `<br><span style="color: #d97706;">‚ö†Ô∏è ${emptyHeaderCount} kolom kosong disembunyikan dari preview.</span>` : 
                            '<br><span style="color: #059669;">‚úÖ Semua kolom memiliki header.</span>'
                        }
                    </div>
                `;
            } else {
                sampleDataHtml += '<p style="color: #6b7280; font-style: italic;">Tidak ada data preview tersedia</p>';
            }
            
            sampleDataContainer.innerHTML = sampleDataHtml;
            analysisResult.style.display = 'block';
            
            // Scroll to analysis result
            analysisResult.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function showValidationModal(data) {
            const modal = document.getElementById('validationModal');
            const errorSummary = document.getElementById('errorSummary');
            const errorList = document.getElementById('errorList');
            
            // Create enhanced summary
            const totalErrors = data.total_errors || data.validation_errors.length;
            const displayedErrors = data.validation_errors.length;
            
            // Analyze error types
            const errorTypes = {};
            data.validation_errors.forEach(error => {
                if (error.includes('cannot be NULL')) {
                    errorTypes['NULL Constraint'] = (errorTypes['NULL Constraint'] || 0) + 1;
                } else if (error.includes('Invalid')) {
                    errorTypes['Invalid Value'] = (errorTypes['Invalid Value'] || 0) + 1;
                } else if (error.includes('exceeds maximum length')) {
                    errorTypes['Length Constraint'] = (errorTypes['Length Constraint'] || 0) + 1;
                } else {
                    errorTypes['Other'] = (errorTypes['Other'] || 0) + 1;
                }
            });
            
            let errorTypesSummary = Object.entries(errorTypes).map(([type, count]) => 
                `<span style="display: inline-block; background: #fef2f2; color: #dc2626; padding: 4px 8px; margin: 2px; border-radius: 4px; font-size: 0.875rem;">
                    ${type}: ${count}
                </span>`
            ).join('');
            
            errorSummary.innerHTML = `
                <div style="background: #fef2f2; padding: 16px; border-radius: 8px; border: 1px solid #fecaca; margin-bottom: 16px;">
                    <h5 style="color: #dc2626; margin-bottom: 12px;">üìä Error Analysis</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;">${totalErrors}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Total Errors</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;">${displayedErrors}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Shown Below</div>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <strong style="color: #374151;">Error Types:</strong><br>
                        ${errorTypesSummary}
                    </div>
                </div>
            `;
            
            // Create enhanced error list
            errorList.innerHTML = '';
            data.validation_errors.forEach((error, index) => {
                const errorItem = document.createElement('li');
                errorItem.className = 'error-item';
                
                const formattedError = formatErrorMessage(error);
                errorItem.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="color: #dc2626; font-weight: bold; min-width: 24px;">${index + 1}.</span>
                        <div style="flex: 1;">${formattedError}</div>
                    </div>
                `;
                
                errorList.appendChild(errorItem);
            });
            
            modal.style.display = 'block';
        }

        function formatErrorMessage(error) {
            // Parse the error message and highlight different parts
            let formatted = error;
            
            // Highlight Row number
            formatted = formatted.replace(
                /Row (\d+)/g,
                '<span class="error-row">Row $1</span>'
            );
            
            // Highlight Column name
            formatted = formatted.replace(
                /Column '([^']+)'/g,
                '<span class="error-column">Column \'$1\'</span>'
            );
            
            // Highlight Value
            formatted = formatted.replace(
                /Value '([^']+)'/g,
                '<span class="error-value">Value \'$1\'</span>'
            );
            
            // Highlight specific error types
            formatted = formatted.replace(
                /(cannot be NULL)/gi,
                '<strong style="color: #dc2626;">$1</strong>'
            );
            
            formatted = formatted.replace(
                /(Invalid|Error|Failed)/gi,
                '<strong style="color: #dc2626;">$1</strong>'
            );
            
            return formatted;
        }

        function closeValidationModal() {
            document.getElementById('validationModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('validationModal');
            if (event.target == modal) {
                closeValidationModal();
            }
        }

        function createResultDetails(data) {
            let details = '<table style="width: 100%; margin-top: 15px;">';
            details += `<tr><th style="width: 40%;">Baris Berhasil Insert</th><td><strong style="color: #059669;">${(data.inserted_rows || 0).toLocaleString()}</strong></td></tr>`;
            
            // Enhanced header info display
            if (data.header_info) {
                const headerInfo = data.header_info;
                
                if (headerInfo.sheet_used) {
                    details += `<tr><th>Sheet Digunakan</th><td><strong>${headerInfo.sheet_used}</strong></td></tr>`;
                }
                
                // Column matching statistics
                if (headerInfo.matched_columns !== undefined && headerInfo.required_columns !== undefined) {
                    const matchPercentage = Math.round((headerInfo.matched_columns / headerInfo.required_columns) * 100);
                    details += `<tr><th>Kolom Berhasil Dipetakan</th><td><strong style="color: ${matchPercentage >= 80 ? '#059669' : '#d97706'};">${headerInfo.matched_columns}/${headerInfo.required_columns} (${matchPercentage}%)</strong></td></tr>`;
                }
                
                if (headerInfo.header_row) {
                    details += `<tr><th>Header Baris</th><td>${headerInfo.header_row}</td></tr>`;
                }
                
                if (headerInfo.data_start_row) {
                    details += `<tr><th>Data Mulai Baris</th><td>${headerInfo.data_start_row}</td></tr>`;
                }
                
                if (headerInfo.detected_primary) {
                    details += `<tr><th>Primary Header</th><td><strong>${headerInfo.detected_primary}</strong></td></tr>`;
                }
                
                // Validation warnings count
                if (headerInfo.validation_warnings !== undefined && headerInfo.validation_warnings > 0) {
                    details += `<tr><th>Warning Validasi</th><td><strong style="color: #d97706;">${headerInfo.validation_warnings} peringatan</strong></td></tr>`;
                }
            }
            
            // Format periode date
            if (data.periode_date || (data.header_info && data.header_info.periode_date)) {
                const periodeDate = data.periode_date || data.header_info.periode_date;
                const formattedDate = formatToIndonesianDate(periodeDate);
                details += `<tr><th>Periode Date</th><td><strong>${formattedDate}</strong></td></tr>`;
            }
            
            if (data.upload_date) {
                details += `<tr><th>Upload Date</th><td><strong>${data.upload_date}</strong></td></tr>`;
            }
            
            details += '</table>';
            
            // Enhanced missing headers handling
            if (data.header_info && data.header_info.missing_headers && data.header_info.missing_headers.length > 0) {
                const automaticColumns = ['period_date', 'upload_date', 'id'];
                const actualMissingHeaders = data.header_info.missing_headers.filter(header => 
                    !automaticColumns.some(autoCol => autoCol.toLowerCase() === header.toLowerCase())
                );
                
                if (actualMissingHeaders.length > 0) {
                    details += '<div style="margin-top: 15px; padding: 12px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px;">';
                    details += '<h6 style="color: #92400e; margin-bottom: 8px;">‚ö†Ô∏è Kolom Tidak Ditemukan dengan Pencocokan Nama:</h6>';
                    details += '<div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px;">';
                    actualMissingHeaders.forEach(header => {
                        details += `<span style="background: #fed7aa; color: #92400e; padding: 3px 6px; border-radius: 3px; font-size: 0.75rem;">${header}</span>`;
                    });
                    details += '</div>';
                    details += '<p style="margin: 0; font-size: 0.875rem; color: #92400e;">Kolom ini ditangani dengan nilai default atau NULL berdasarkan konfigurasi database.</p>';
                    details += '</div>';
                }
            }
            
            // Enhanced validation warnings display
            if (data.validation_warnings && data.validation_warnings.length > 0 && data.validation_warnings.length <= 5) {
                details += '<div style="margin-top: 15px; padding: 12px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px;">';
                details += '<h6 style="color: #92400e; margin-bottom: 8px;">‚ö†Ô∏è Peringatan Validasi Data:</h6>';
                details += '<ul style="margin: 0; padding-left: 16px; font-size: 0.875rem; color: #92400e;">';
                data.validation_warnings.forEach(warning => {
                    details += `<li style="margin-bottom: 4px;">${formatErrorMessage(warning)}</li>`;
                });
                details += '</ul>';
                details += '<p style="margin: 8px 0 0 0; font-size: 0.75rem; color: #6b7280; font-style: italic;">Data tetap berhasil diproses dengan penanganan otomatis.</p>';
                details += '</div>';
            }
            
            return details;
        }

        function createErrorDetails(data) {
            let details = '<div style="margin-top: 15px;">';
            
            // Enhanced header mismatch information
            if (data.header_info) {
                const headerInfo = data.header_info;
                
                details += '<h5 style="color: #dc2626; margin-bottom: 12px;">üìä Informasi Header Matching:</h5>';
                
                // Statistics
                if (headerInfo.matched_columns !== undefined && headerInfo.required_columns !== undefined) {
                    const matchPercentage = Math.round((headerInfo.matched_columns / headerInfo.required_columns) * 100);
                    details += `<div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-bottom: 15px;">`;
                    details += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; text-align: center;">`;
                    details += `<div><div style="font-size: 1.5rem; font-weight: bold; color: ${matchPercentage >= 50 ? '#059669' : '#dc2626'};">${headerInfo.matched_columns}</div><div style="font-size: 0.875rem; color: #6b7280;">Kolom Cocok</div></div>`;
                    details += `<div><div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;">${headerInfo.required_columns}</div><div style="font-size: 0.875rem; color: #6b7280;">Total Dibutuhkan</div></div>`;
                    details += `<div><div style="font-size: 1.5rem; font-weight: bold; color: ${matchPercentage >= 50 ? '#059669' : '#dc2626'};">${matchPercentage}%</div><div style="font-size: 0.875rem; color: #6b7280;">Tingkat Kecocokan</div></div>`;
                    details += `</div></div>`;
                }
                
                // Detailed column comparison
                if (headerInfo.found_headers && headerInfo.found_headers.length > 0) {
                    details += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">';
                    
                    // Found headers
                    details += '<div><h6 style="color: #6b7280; margin-bottom: 8px;">Header yang Berhasil Dipetakan:</h6>';
                    details += '<div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px; padding: 10px; max-height: 200px; overflow-y: auto;">';
                    headerInfo.found_headers.forEach(header => {
                        details += `<div style="padding: 2px 0; color: #059669; font-size: 0.875rem;">‚úì ${header}</div>`;
                    });
                    details += '</div></div>';
                    
                    // Missing headers
                    if (headerInfo.missing_headers && headerInfo.missing_headers.length > 0) {
                        // Filter out automatic columns
                        const automaticColumns = ['period_date', 'upload_date', 'id'];
                        const actualMissingHeaders = headerInfo.missing_headers.filter(header => 
                            !automaticColumns.some(autoCol => autoCol.toLowerCase() === header.toLowerCase())
                        );
                        
                        if (actualMissingHeaders.length > 0) {
                            details += '<div><h6 style="color: #6b7280; margin-bottom: 8px;">Header yang Tidak Ditemukan:</h6>';
                            details += '<div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 10px; max-height: 200px; overflow-y: auto;">';
                            actualMissingHeaders.forEach(header => {
                                details += `<div style="padding: 2px 0; color: #dc2626; font-size: 0.875rem;">‚úó ${header}</div>`;
                            });
                            details += '</div></div>';
                        }
                    }
                    
                    details += '</div>';
                }
            }
            
            // Enhanced suggestions
            const suggestions = [
                'Pastikan nama kolom di Excel sesuai dengan template yang telah ditentukan',
                'Periksa ejaan dan spasi pada header kolom',
                'Header dapat menggunakan spasi yang akan dikonversi ke underscore secara otomatis',
                'Gunakan fungsi "Preview Header DB" untuk melihat struktur kolom yang dibutuhkan',
                'Pastikan sheet yang dipilih memiliki struktur data yang benar'
            ];
            
            if (data.header_info && data.header_info.matched_columns !== undefined) {
                const matchPercentage = Math.round((data.header_info.matched_columns / data.header_info.required_columns) * 100);
                
                if (matchPercentage < 50) {
                    suggestions.push('Tingkat kecocokan sangat rendah - periksa apakah Anda memilih sheet dan template yang benar');
                } else if (matchPercentage < 80) {
                    suggestions.push('Beberapa kolom tidak cocok - sistem akan menggunakan pencocokan posisi sebagai fallback');
                }
            }
            
            details += '<h5 style="color: #1e40af; margin-bottom: 12px;">üí° Saran Perbaikan:</h5>';
            details += '<ul style="margin-left: 20px; color: #475569; line-height: 1.6;">';
            suggestions.forEach(suggestion => {
                details += `<li style="margin-bottom: 8px;">${suggestion}</li>`;
            });
            details += '</ul>';
            
            details += '</div>';
            return details;
        }

        function showAlert(type, message) {
            // Create temporary alert
            const alert = document.createElement('div');
            alert.className = `result ${type}`;
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                max-width: 400px;
                margin: 0;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                animation: slideIn 0.3s ease-out;
            `;
            alert.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.2rem; padding: 0 5px;">√ó</button>
                </div>
            `;
            
            document.body.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }

        function validateMonthYear(dateString) {
            // Cek format YYYY-MM
            return /^\d{4}-(0[1-9]|1[0-2])$/.test(dateString);
        }

        function formatToIndonesianDate(dateString) {
            const monthNames = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            
            const date = new Date(dateString);
            const monthName = monthNames[date.getMonth()];
            const year = date.getFullYear();
            
            return `${monthName} ${year}`;
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePhone(phone) {
            const re = /^[\+]?[0-9\-\(\)\s]+$/;
            return re.test(phone) && phone.replace(/\D/g, '').length >= 10;
        }

        function loadSheetsFromFile(file) {
            const sheetSelect = document.getElementById('sheet_name');
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/get-excel-sheets', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Populate sheet dropdown
                    sheetSelect.innerHTML = '';
                    
                    if (result.sheets && result.sheets.length > 0) {
                        result.sheets.forEach(sheet => {
                            const option = document.createElement('option');
                            option.value = sheet;
                            option.textContent = sheet;
                            
                            // Set default sheet sebagai selected
                            if (sheet === result.default_sheet) {
                                option.selected = true;
                            }
                            
                            sheetSelect.appendChild(option);
                        });
                        
                        sheetSelect.disabled = false;
                        
                        // Show success message
                        showAlert('success', `Ditemukan ${result.sheets.length} sheet: ${result.sheets.join(', ')}`);
                    } else {
                        sheetSelect.innerHTML = '<option value="">-- Tidak ada sheet ditemukan --</option>';
                        sheetSelect.disabled = true;
                        showAlert('warning', 'Tidak ada sheet yang ditemukan di file Excel');
                    }
                } else {
                    sheetSelect.innerHTML = '<option value="">-- Error loading sheets --</option>';
                    sheetSelect.disabled = true;
                    showAlert('error', result.message || 'Gagal memuat daftar sheet');
                }
            })
            .catch(error => {
                console.error('Error loading sheets:', error);
                sheetSelect.innerHTML = '<option value="">-- Error loading sheets --</option>';
                sheetSelect.disabled = true;
                showAlert('error', 'Terjadi kesalahan saat memuat daftar sheet');
            });
        }

        // Add file info display when file is selected
        document.getElementById('file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const sheetSelect = document.getElementById('sheet_name');

            if (file) {
                // Reset dan disable sheet dropdown
                sheetSelect.innerHTML = '<option value="">-- Loading sheets... --</option>';
                sheetSelect.disabled = true;
                
                // Load sheets dari file
                loadSheetsFromFile(file);

                const fileInfo = document.createElement('div');
                fileInfo.id = 'fileInfo';
                fileInfo.style.cssText = `
                    margin-top: 10px;
                    padding: 12px;
                    background: #f8fafc;
                    border: 1px solid #e2e8f0;
                    border-radius: 6px;
                    font-size: 0.875rem;
                    color: #475569;
                `;
                fileInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>üìÑ ${file.name}</strong>
                        <span>${formatFileSize(file.size)}</span>
                    </div>
                `;
                
                // Remove existing file info
                const existingInfo = document.getElementById('fileInfo');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                // Add new file info after file input
                e.target.parentElement.appendChild(fileInfo);
            } else {
                // Reset sheet dropdown jika tidak ada file
                sheetSelect.innerHTML = '<option value="">-- Pilih file Excel terlebih dahulu --</option>';
                sheetSelect.disabled = true;
            }
        });

        // Add CSS animation for alerts
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);

        document.addEventListener('DOMContentLoaded', function() {
            testConnection();
            
            // Validasi real-time untuk periode date
            const periodeInput = document.getElementById('periode_date');
            if (periodeInput) {
                periodeInput.addEventListener('change', function() {
                    const dateValue = this.value;
                    if (dateValue && !validateMonthYear(dateValue)) {
                        showAlert('warning', 'Format tanggal tidak valid. Gunakan format YYYY-MM.');
                        this.focus();
                    }
                });
            }
        });
    </script>
{% endblock %}