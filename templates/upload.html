{% extends "header.html" %}

{% block title %}Upload Files{% endblock %}

{% block content %}
    <!-- Sidebar -->
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Content -->
        <div class="content">
            <div class="content-header">
                <h2 class="content-title">Excel File Upload</h2>
                <p class="content-subtitle">Upload and process your Excel files with template matching</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üìÅ</span>
                        File Upload Configuration
                    </h3>
                </div>
                <div class="card-body">
                    <div class="info-box">
                        <h3>‚ÑπÔ∏è Informasi Penting</h3>
                        <strong>Format File:</strong> Mendukung .xlsx dan .xls (maksimal 16MB)
                    </div>

                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="grid-container">
                            <div class="form-group">
                                <label for="table_name" class="form-label">Pilih template</label>
                                <select id="table_name" name="table_name" class="form-control form-select" required>
                                    <option value="">-- Pilih template --</option>
                                    {% for table in template_tables %}
                                    <option value="{{ table }}">{{ table|replace('_', ' ')|title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="file" class="form-label">Pilih File Excel</label>
                                <input type="file" id="file" name="file" class="form-control" accept=".xlsx,.xls" required>
                                <div class="form-text">Format: .xlsx atau .xls, maksimal 16MB</div>
                            </div>
                            <div class="form-group">
                                <label for="sheet_name" class="form-label">Pilih Sheet</label>
                                <select id="sheet_name" name="sheet_name" class="form-control form-select" disabled required>
                                    <option value="">-- Pilih file Excel terlebih dahulu --</option>
                                </select>
                                <div class="form-text">Pilih sheet yang akan diproses dari file Excel</div>
                            </div>
                            <div class="form-group">
                                <label for="periode_date" class="form-label">Periode Date</label>
                                <input type="date" id="periode_date" name="periode_date" class="form-control" required>
                                <div class="form-text">Periode Date diambil dari form input, tidak dari file Excel</div>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-info" onclick="analyzeFile()">
                                <span>üîç</span>
                                Analisis File
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="previewHeaders()">
                                <span>üëÅÔ∏è</span>
                                Preview Header DB
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <span>üì§</span>
                                Upload & Insert Data
                            </button>
                            <!-- <button type="button" class="btn btn-danger" onclick="simulateValidationError()">
                                üß™ Test Validation Error
                            </button> -->
                        </div>
                    </form>

                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Memproses file Excel...</p>
                    </div>

                    <div class="result" id="result">
                        <div class="result-header">
                            <div class="result-title" id="resultTitle"></div>
                            <div class="result-subtitle"></div>
                        </div>
                        <div class="result-content">
                            <div class="status-indicator"></div>
                            <div class="result-message">
                                <div class="result-text" id="resultText"></div>
                            </div>
                            <div class="result-details" id="resultDetails"></div>
                        </div>
                        <div class="result-footer"></div>
                    </div>

                    <div class="analysis-result" id="analysisResult">
                        <h4>üìã Hasil Analisis File Excel</h4>
                        <div class="analysis-grid" id="analysisGrid"></div>
                        <div id="sampleDataContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Validation Error Modal -->
    <div id="validationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>üìã Validation Error Details</h4>
                <span class="close" onclick="closeValidationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="error-summary" id="errorSummary"></div>
                <ul class="error-list" id="errorList"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeValidationModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Test koneksi database saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            testConnection();
        });

        function testConnection() {
            // Simulasi test koneksi database
            console.log('Testing database connection...');
            
            // Show connection status in console
            setTimeout(() => {
                console.log('‚úÖ Database connection successful');
            }, 500);
        }

        function analyzeFile() {
            const fileInput = document.getElementById('file');
            const sheetSelect = document.getElementById('sheet_name');
            const file = fileInput.files[0];

            if (!file) {
                showAlert('error', 'Pilih file Excel terlebih dahulu');
                return;
            }

            // Validasi sheet selection
            if (!sheetSelect.value) {
                showAlert('warning', 'Pilih sheet yang akan dianalisis');
                sheetSelect.focus();
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('sheet_name', sheetSelect.value);

            showLoading(true, 'Menganalisis file Excel...');
            hideResult();

            fetch('/analyze-excel', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                if (result.success) {
                    showAnalysisResult(result.analysis);
                } else {
                    showAlert('error', result.message || 'Gagal menganalisis file.');
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('error', 'Terjadi kesalahan saat analisis: ' + error);
            });
        }

        function previewHeaders() {
            const tableSelect = document.getElementById('table_name');
            const tableName = tableSelect.value.trim();

            if (!tableName) {
                showAlert('warning', 'Pilih template terlebih dahulu');
                tableSelect.focus();
                return;
            }

            showLoading(true, 'Memuat header database...');
            hideResult();

            fetch(`/preview-headers/${tableName}`)
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                if (result.success) {
                    let headers = result.headers || {};
                    let headerEntries = Object.entries(headers);
                    
                    // Pisahkan kolom berdasarkan jenis
                    let excelColumns = [];
                    let automaticColumns = [];
                    
                    headerEntries.forEach(([name, info]) => {
                        if (info.is_automatic) {
                            automaticColumns.push([name, info]);
                        } else {
                            excelColumns.push([name, info]);
                        }
                    });

                    // Buat HTML untuk kolom Excel (yang harus ada di file)
                    let excelColumnsList = excelColumns.map(([name, info]) => {
                        let detail = `(${info.data_type}`;
                        if (info.max_length) detail += `, max ${info.max_length}`;
                        if (info.precision !== null && info.scale !== null) detail += `, precision ${info.precision}, scale ${info.scale}`;
                        detail += info.is_nullable ? ', nullable' : ', not null';
                        detail += ')';

                        return `
                            <li>
                                <span class="column-name">${name}</span>
                                <span class="column-details">${detail}</span>
                            </li>`;
                    }).join('');

                    // Buat HTML untuk kolom otomatis
                    let automaticColumnsList = automaticColumns.map(([name, info]) => {
                        let detail = `(${info.data_type}`;
                        if (info.max_length) detail += `, max ${info.max_length}`;
                        if (info.precision !== null && info.scale !== null) detail += `, precision ${info.precision}, scale ${info.scale}`;
                        detail += info.is_nullable ? ', nullable' : ', not null';
                        detail += ')';

                        let description = '';
                        if (name.toLowerCase() === 'id') {
                            description = ' - Auto increment primary key';
                        } else if (name.toLowerCase() === 'period_date') {
                            description = ' - Diisi dari form Periode Date';
                        } else if (name.toLowerCase() === 'upload_date') {
                            description = ' - Otomatis diisi saat upload';
                        }

                        return `
                            <li>
                                <span class="column-name">${name}</span>
                                <span class="column-details">${detail}${description}</span>
                                <span class="tag tag-auto">Auto</span>
                            </li>`;
                    }).join('');

                    // Buat konten lengkap dengan struktur yang sesuai
                    let details = `
                        <div class="info-card">
                            <div class="info-card-title">
                                Kolom Yang Harus Ada di File Excel (${excelColumns.length} kolom)
                            </div>
                            <ul class="info-list">
                                ${excelColumnsList}
                            </ul>
                        </div>`;

                    // Buat message content
                    let messageContent = `
                        <div class="result-text">
                            Template database berhasil dimuat. Silakan periksa struktur kolom di bawah ini sebelum melakukan upload data.
                        </div>`;

                    // Panggil showResult dengan parameter yang sesuai
                    showResult('success', `Header Database - ${tableName}`, messageContent, details);

                } else {
                    showAlert('error', result.message || 'Gagal memuat header.');
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('error', 'Terjadi kesalahan saat memuat header: ' + error.message);
            });
        }

        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const tableSelect = document.getElementById('table_name');
            const fileInput = document.getElementById('file');
            const sheetSelect = document.getElementById('sheet_name');
            const periodeDate = document.getElementById('periode_date');
            const file = fileInput.files[0];
            
            // Enhanced validation
            if (!tableSelect.value) {
                showAlert('warning', 'Pilih template terlebih dahulu');
                tableSelect.focus();
                return;
            }
            
            if (!file) {
                showAlert('warning', 'Pilih file Excel terlebih dahulu');
                fileInput.focus();
                return;
            }
            
            if (!sheetSelect.value) {
                showAlert('warning', 'Pilih sheet yang akan diproses');
                sheetSelect.focus();
                return;
            }
            
            if (!periodeDate.value) {
                showAlert('warning', 'Tentukan periode date terlebih dahulu');
                periodeDate.focus();
                return;
            }
            
            // Validate date format
            if (!validateDate(periodeDate.value)) {
                showAlert('error', 'Format tanggal periode tidak valid. Gunakan format YYYY-MM-DD');
                periodeDate.focus();
                return;
            }

            const formData = new FormData();
            formData.append('table_name', tableSelect.value);
            formData.append('primary_header', document.getElementById('primary_header')?.value || '');
            formData.append('file', file);
            formData.append('sheet_name', sheetSelect.value);
            formData.append('periode_date', periodeDate.value);

            // Check period existence first
            fetch('/check-period', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    table_name: tableSelect.value,
                    periode_date: periodeDate.value
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    if (result.exists) {
                        const confirmReplace = confirm(`‚ö†Ô∏è Data untuk periode ${periodeDate.value} sudah ada di tabel ${tableSelect.value}.\n\nApakah Anda yakin ingin mengganti data tersebut?\n\n‚ö†Ô∏è Perhatian: Data lama akan dihapus dan tidak dapat dikembalikan!`);
                        if (!confirmReplace) {
                            showAlert('info', 'Proses upload dibatalkan oleh user.');
                            return;
                        }
                    }

                    // Proceed with upload
                    showLoading(true, 'Validating and processing Excel file...');
                    hideResult();

                    fetch('/upload', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        showLoading(false);
                        if (data.success) {
                            const details = createResultDetails(data);
                            showResult('success', 'Upload Successful! üéâ',
                                'File Excel berhasil divalidasi dan data telah dimasukkan ke database.', details);
                        } else {
                            // Enhanced error handling untuk berbagai jenis error
                            let errorDetails = '';
                            
                            if (data.validation_errors) {
                                // Validation errors - handled in showResult
                                errorDetails = '';
                            } else if (data.found_headers && data.expected_headers) {
                                // Header mismatch errors
                                errorDetails = createErrorDetails(data);
                            } else {
                                // General errors
                                errorDetails = data.header_info ? createHeaderInfoDetails(data.header_info) : '';
                            }
                            
                            showResult('error', 'Upload Failed! ‚ùå',
                                data.message || 'Terjadi kesalahan saat memproses file Excel.', errorDetails, data);
                        }
                    })
                    .catch(error => {
                        showLoading(false);
                        console.error('Upload Error:', error);
                        showResult('error', 'Upload Failed! ‚ùå', 
                            'Terjadi kesalahan jaringan saat mengupload file. Silakan coba lagi.', '');
                    });

                } else {
                    showAlert('error', result.message || 'Gagal mengecek data periode.');
                }
            })
            .catch(error => {
                console.error('Period check error:', error);
                showAlert('error', 'Terjadi kesalahan saat mengecek data periode: ' + error.message);
            });
        });

        function createHeaderInfoDetails(headerInfo) {
            if (!headerInfo) return '';
            
            let details = '<div style="margin-top: 15px;"><h5 style="color: #374151; margin-bottom: 10px;">üìã File Processing Info:</h5>';
            details += '<table style="width: 100%; font-size: 0.875rem;">';
            
            if (headerInfo.sheet_used) {
                details += `<tr><td style="width: 40%; font-weight: 600;">Sheet Used:</td><td>${headerInfo.sheet_used}</td></tr>`;
            }
            if (headerInfo.header_row) {
                details += `<tr><td style="font-weight: 600;">Header Row:</td><td>${headerInfo.header_row}</td></tr>`;
            }
            if (headerInfo.data_start_row) {
                details += `<tr><td style="font-weight: 600;">Data Start Row:</td><td>${headerInfo.data_start_row}</td></tr>`;
            }
            if (headerInfo.detected_primary) {
                details += `<tr><td style="font-weight: 600;">Primary Header:</td><td>${headerInfo.detected_primary}</td></tr>`;
            }
            
            details += '</table></div>';
            return details;
        }

        function showLoading(show, message = 'Memproses file Excel...') {
            const loading = document.getElementById('loading');
            const loadingText = loading.querySelector('p');
            const buttons = document.querySelectorAll('.btn');
            
            if (show) {
                loading.style.display = 'block';
                loadingText.textContent = message;
                buttons.forEach(btn => btn.disabled = true);
                
                // Add loading animation to buttons
                buttons.forEach(btn => {
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                });
            } else {
                loading.style.display = 'none';
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });
            }
        }

        function showResult(type, title, message, details = '', data = null) {
            const result = document.getElementById('result');
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultText');
            const resultDetails = document.getElementById('resultDetails');
            
            result.className = `result ${type}`;
            result.style.display = 'block';
            resultTitle.innerHTML = title;
            
            // Handle validation errors dengan informasi lebih lengkap
            if (type === 'error' && data && data.validation_errors) {
                const totalErrors = data.total_errors || data.validation_errors.length;
                const displayedErrors = Math.min(data.validation_errors.length, 5); // Show max 5 errors in summary
                
                // Create validation error summary
                let errorSummary = `
                    <div class="validation-error-summary">
                        <h5>üö® Data Validation Failed</h5>
                        <div class="error-stats">
                            <div class="error-stat">
                                <div class="error-stat-number">${totalErrors}</div>
                                <div class="error-stat-label">Total Errors</div>
                            </div>
                            <div class="error-stat">
                                <div class="error-stat-number">${data.inserted_rows || 0}</div>
                                <div class="error-stat-label">Rows Processed</div>
                            </div>
                            <div class="error-stat">
                                <div class="error-stat-number">0</div>
                                <div class="error-stat-label">Rows Inserted</div>
                            </div>
                        </div>
                        <p style="color: #dc2626; font-weight: 500; margin: 12px 0;">
                            ‚ö†Ô∏è The entire operation was cancelled due to validation errors. No data was inserted into the database.
                        </p>
                `;
                
                // Show first few errors in summary
                if (data.validation_errors.length > 0) {
                    errorSummary += '<h6 style="color: #374151; margin: 16px 0 8px 0;">Sample Errors:</h6>';
                    errorSummary += '<ul style="margin: 0; padding-left: 0; list-style: none;">';
                    
                    data.validation_errors.slice(0, displayedErrors).forEach((error, index) => {
                        const formattedError = formatErrorMessage(error);
                        errorSummary += `<li class="error-item">${formattedError}</li>`;
                    });
                    
                    errorSummary += '</ul>';
                    
                    if (totalErrors > displayedErrors) {
                        errorSummary += `
                            <div style="text-align: center; margin-top: 12px;">
                                <button type="button" class="btn btn-secondary" onclick="showValidationModal(${JSON.stringify(data).replace(/"/g, '&quot;')})">
                                    View All ${totalErrors} Errors
                                </button>
                            </div>
                        `;
                    }
                }
                
                errorSummary += '</div>';
                
                resultMessage.innerHTML = `
                    <div class="result-text">${message}</div>
                    ${errorSummary}
                `;
            } else {
                resultMessage.innerHTML = message;
            }
            
            resultDetails.innerHTML = details;
            
            // Scroll to result
            result.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideResult() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('analysisResult').style.display = 'none';
        }

        function showAnalysisResult(analysis) {
            const analysisResult = document.getElementById('analysisResult');
            const analysisGrid = document.getElementById('analysisGrid');
            const sampleDataContainer = document.getElementById('sampleDataContainer');
            
            // Create analysis grid dengan info sheet
            analysisGrid.innerHTML = `
                <div class="analysis-item">
                    <div class="label">Sheet Digunakan</div>
                    <div class="value">${analysis.sheet_name || 'Sheet pertama'}</div>
                </div>
                <div class="analysis-item">
                    <div class="label">Total Baris</div>
                    <div class="value">${analysis.total_rows.toLocaleString()}</div>
                </div>
                <div class="analysis-item">
                    <div class="label">Total Kolom</div>
                    <div class="value">${analysis.total_columns}</div>
                </div>
                <div class="analysis-item">
                    <div class="label">Baris Header</div>
                    <div class="value">${analysis.header_row}</div>
                </div>
                <div class="analysis-item">
                    <div class="label">Baris Data Mulai</div>
                    <div class="value">${analysis.data_start_row}</div>
                </div>
                <div class="analysis-item">
                    <div class="label">Jumlah Data (baris)</div>
                    <div class="value">${analysis.data_rows_available.toLocaleString()}</div>
                </div>
            `;
            
            // Sisanya sama seperti sebelumnya...
            let sampleDataHtml = '<h4>üìÑ Preview Data (3 baris pertama)</h4>';
            if (analysis.sample_data && analysis.sample_data.length > 0) {
                sampleDataHtml += '<div class="sample-data"><table>';
                
                // Header row dengan numbering - skip empty headers
                sampleDataHtml += '<thead><tr><th style="width: 50px; text-align: center;">#</th>';
                analysis.headers.forEach(header => {
                    const isEmpty = !header || header.trim() === '';
                    // Skip empty columns completely
                    if (!isEmpty) {
                        sampleDataHtml += `<th title="${header}">${header}</th>`;
                    }
                });
                sampleDataHtml += '</tr></thead>';
                
                // Sample data rows dengan row numbers - skip empty columns
                sampleDataHtml += '<tbody>';
                analysis.sample_data.forEach((row, index) => {
                    sampleDataHtml += `<tr><td style="text-align: center; font-weight: 600; color: #6b7280;">${index + 1}</td>`;
                    row.forEach((cell, cellIndex) => {
                        // Only show data for non-empty header columns
                        const header = analysis.headers[cellIndex];
                        const headerIsEmpty = !header || header.trim() === '';
                        
                        if (!headerIsEmpty) {
                            const cellValue = cell || '';
                            const isNumber = !isNaN(cellValue) && cellValue !== '';
                            sampleDataHtml += `<td style="${isNumber ? 'text-align: right; font-family: monospace;' : ''}" title="${cellValue}">
                                ${cellValue.length > 20 ? cellValue.substring(0, 20) + '...' : cellValue}
                            </td>`;
                        }
                    });
                    sampleDataHtml += '</tr>';
                });
                sampleDataHtml += '</tbody></table></div>';
                
                // Add summary info - only count actual data columns
                const validHeaders = analysis.headers.filter(h => h && h.trim() !== '');
                const emptyHeaderCount = analysis.headers.filter(h => !h || h.trim() === '').length;
                
                sampleDataHtml += `
                    <div style="margin-top: 15px; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.875rem;">
                        <strong>üìä Ringkasan:</strong> Menampilkan ${Math.min(3, analysis.sample_data.length)} dari ${analysis.data_rows_available} baris data dengan ${validHeaders.length} kolom valid.
                        ${emptyHeaderCount > 0 ? 
                            `<br><span style="color: #d97706;">‚ö†Ô∏è ${emptyHeaderCount} kolom kosong disembunyikan dari preview.</span>` : 
                            '<br><span style="color: #059669;">‚úÖ Semua kolom memiliki header.</span>'
                        }
                    </div>
                `;
            } else {
                sampleDataHtml += '<p style="color: #6b7280; font-style: italic;">Tidak ada data preview tersedia</p>';
            }
            
            sampleDataContainer.innerHTML = sampleDataHtml;
            analysisResult.style.display = 'block';
            
            // Scroll to analysis result
            analysisResult.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function showValidationModal(data) {
            const modal = document.getElementById('validationModal');
            const errorSummary = document.getElementById('errorSummary');
            const errorList = document.getElementById('errorList');
            
            // Create enhanced summary
            const totalErrors = data.total_errors || data.validation_errors.length;
            const displayedErrors = data.validation_errors.length;
            
            // Analyze error types
            const errorTypes = {};
            data.validation_errors.forEach(error => {
                if (error.includes('cannot be NULL')) {
                    errorTypes['NULL Constraint'] = (errorTypes['NULL Constraint'] || 0) + 1;
                } else if (error.includes('Invalid')) {
                    errorTypes['Invalid Value'] = (errorTypes['Invalid Value'] || 0) + 1;
                } else if (error.includes('exceeds maximum length')) {
                    errorTypes['Length Constraint'] = (errorTypes['Length Constraint'] || 0) + 1;
                } else {
                    errorTypes['Other'] = (errorTypes['Other'] || 0) + 1;
                }
            });
            
            let errorTypesSummary = Object.entries(errorTypes).map(([type, count]) => 
                `<span style="display: inline-block; background: #fef2f2; color: #dc2626; padding: 4px 8px; margin: 2px; border-radius: 4px; font-size: 0.875rem;">
                    ${type}: ${count}
                </span>`
            ).join('');
            
            errorSummary.innerHTML = `
                <div style="background: #fef2f2; padding: 16px; border-radius: 8px; border: 1px solid #fecaca; margin-bottom: 16px;">
                    <h5 style="color: #dc2626; margin-bottom: 12px;">üìä Error Analysis</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;">${totalErrors}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Total Errors</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;">${displayedErrors}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Shown Below</div>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <strong style="color: #374151;">Error Types:</strong><br>
                        ${errorTypesSummary}
                    </div>
                </div>
            `;
            
            // Create enhanced error list
            errorList.innerHTML = '';
            data.validation_errors.forEach((error, index) => {
                const errorItem = document.createElement('li');
                errorItem.className = 'error-item';
                
                const formattedError = formatErrorMessage(error);
                errorItem.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="color: #dc2626; font-weight: bold; min-width: 24px;">${index + 1}.</span>
                        <div style="flex: 1;">${formattedError}</div>
                    </div>
                `;
                
                errorList.appendChild(errorItem);
            });
            
            modal.style.display = 'block';
        }

        function formatErrorMessage(error) {
            // Parse the error message and highlight different parts
            let formatted = error;
            
            // Highlight Row number
            formatted = formatted.replace(
                /Row (\d+)/g,
                '<span class="error-row">Row $1</span>'
            );
            
            // Highlight Column name
            formatted = formatted.replace(
                /Column '([^']+)'/g,
                '<span class="error-column">Column \'$1\'</span>'
            );
            
            // Highlight Value
            formatted = formatted.replace(
                /Value '([^']+)'/g,
                '<span class="error-value">Value \'$1\'</span>'
            );
            
            // Highlight specific error types
            formatted = formatted.replace(
                /(cannot be NULL)/gi,
                '<strong style="color: #dc2626;">$1</strong>'
            );
            
            formatted = formatted.replace(
                /(Invalid|Error|Failed)/gi,
                '<strong style="color: #dc2626;">$1</strong>'
            );
            
            return formatted;
        }

        function closeValidationModal() {
            document.getElementById('validationModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('validationModal');
            if (event.target == modal) {
                closeValidationModal();
            }
        }

        function createResultDetails(data) {
            let details = '<table style="width: 100%; margin-top: 15px;">';
            details += `<tr><th style="width: 40%;">Baris Berhasil Insert</th><td><strong style="color: #059669;">${(data.inserted_rows || 0).toLocaleString()}</strong></td></tr>`;
            
            // Tambahkan info sheet yang digunakan
            if (data.header_info && data.header_info.sheet_used) {
                details += `<tr><th>Sheet Digunakan</th><td><strong>${data.header_info.sheet_used}</strong></td></tr>`;
            }
            
            // Tambahkan info periode date dengan format Indonesia
            if (data.periode_date) {
                // Function to format date to Indonesian
                function formatToIndonesianDate(dateString) {
                    const monthNames = [
                        'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
                    ];
                    
                    const dayNames = [
                        'Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'
                    ];
                    
                    // Parse the date string
                    const date = new Date(dateString);
                    
                    // Get day name, day, month name, and year
                    const dayName = dayNames[date.getDay()];
                    const day = String(date.getDate()).padStart(2, '0');
                    const monthName = monthNames[date.getMonth()];
                    const year = date.getFullYear();
                    
                    return `${dayName}, ${day} ${monthName} ${year}`;
                }
                
                const formattedDate = formatToIndonesianDate(data.periode_date);
                details += `<tr><th>Periode Date</th><td><strong>${formattedDate}</strong></td></tr>`;
            }
            
            if (data.upload_date) {
                details += `<tr><th>Upload Date</th><td><strong>${data.upload_date}</strong></td></tr>`;
            }
            
            details += `<tr><th>Header Baris</th><td>${data.header_info.header_row}</td></tr>`;
            details += `<tr><th>Data Mulai Baris</th><td>${data.header_info.data_start_row}</td></tr>`;
            details += `<tr><th>Primary Header</th><td><strong>${data.header_info.detected_primary}</strong></td></tr>`;
            details += '</table>';
            
            if (data.columns_used && data.columns_used.length > 0) {
                details += '<div style="margin-top: 20px;"><h5 style="margin-bottom: 10px; color: #374151;">üìã Kolom yang Digunakan dari Excel:</h5>';
                details += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                data.columns_used.forEach(col => {
                    details += `<span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 0.875rem; font-weight: 500;">${col}</span>`;
                });
                details += '</div></div>';
            }
            
            // PERBAIKAN: Hanya tampilkan warning untuk header yang SEHARUSNYA ada di Excel
            // Jangan tampilkan warning untuk kolom otomatis (period_date, upload_date)
            if (data.header_info.missing_headers && data.header_info.missing_headers.length > 0) {
                // Filter out kolom otomatis dari missing headers
                const automaticColumns = ['period_date', 'upload_date', 'id'];
                const actualMissingHeaders = data.header_info.missing_headers.filter(header => 
                    !automaticColumns.includes(header.toLowerCase())
                );
                
                if (actualMissingHeaders.length > 0) {
                    details += '<div style="margin-top: 15px; padding: 12px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px;">';
                    details += '<h6 style="color: #92400e; margin-bottom: 8px;">‚ö†Ô∏è Header Tidak Ditemukan di File Excel:</h6>';
                    details += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
                    actualMissingHeaders.forEach(header => {
                        details += `<span style="background: #fed7aa; color: #92400e; padding: 3px 6px; border-radius: 3px; font-size: 0.75rem;">${header}</span>`;
                    });
                    details += '</div>';
                    details += '<p style="margin-top: 8px; font-size: 0.875rem; color: #92400e;">Kolom ini dilewati saat insert.</p>';
                    details += '</div>';
                }
            }
            
            return details;
        }

        function createErrorDetails(data) {
            let details = '<div style="margin-top: 15px;">';
            
            if (data.found_headers && data.expected_headers) {
                details += '<h5 style="color: #dc2626; margin-bottom: 12px;">üîç Perbandingan Header:</h5>';
                
                details += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">';
                
                // Found headers
                details += '<div><h6 style="color: #6b7280; margin-bottom: 8px;">Header Ditemukan:</h6>';
                details += '<div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 10px;">';
                data.found_headers.forEach(header => {
                    details += `<div style="padding: 2px 0; color: #dc2626; font-size: 0.875rem;">‚Ä¢ ${header}</div>`;
                });
                details += '</div></div>';
                
                // Expected headers
                details += '<div><h6 style="color: #6b7280; margin-bottom: 8px;">Header Yang Diharapkan:</h6>';
                details += '<div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px; padding: 10px;">';
                data.expected_headers.forEach(header => {
                    details += `<div style="padding: 2px 0; color: #059669; font-size: 0.875rem;">‚Ä¢ ${header}</div>`;
                });
                details += '</div></div>';
                
                details += '</div>';
            }
            
            if (data.suggestions && data.suggestions.length > 0) {
                details += '<h5 style="color: #1e40af; margin-bottom: 12px;">üí° Saran Perbaikan:</h5>';
                details += '<ul style="margin-left: 20px; color: #475569; line-height: 1.6;">';
                data.suggestions.forEach(suggestion => {
                    details += `<li style="margin-bottom: 8px;">${suggestion}</li>`;
                });
                details += '</ul>';
            }
            
            details += '</div>';
            return details;
        }

        function showAlert(type, message) {
            // Create temporary alert
            const alert = document.createElement('div');
            alert.className = `result ${type}`;
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                max-width: 400px;
                margin: 0;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                animation: slideIn 0.3s ease-out;
            `;
            alert.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.2rem; padding: 0 5px;">√ó</button>
                </div>
            `;
            
            document.body.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }

        function validateDate(dateString) {
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date) && dateString.match(/^\d{4}-\d{2}-\d{2}$/);
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePhone(phone) {
            const re = /^[\+]?[0-9\-\(\)\s]+$/;
            return re.test(phone) && phone.replace(/\D/g, '').length >= 10;
        }

        function loadSheetsFromFile(file) {
            const sheetSelect = document.getElementById('sheet_name');
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/get-excel-sheets', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Populate sheet dropdown
                    sheetSelect.innerHTML = '';
                    
                    if (result.sheets && result.sheets.length > 0) {
                        result.sheets.forEach(sheet => {
                            const option = document.createElement('option');
                            option.value = sheet;
                            option.textContent = sheet;
                            
                            // Set default sheet sebagai selected
                            if (sheet === result.default_sheet) {
                                option.selected = true;
                            }
                            
                            sheetSelect.appendChild(option);
                        });
                        
                        sheetSelect.disabled = false;
                        
                        // Show success message
                        showAlert('success', `Ditemukan ${result.sheets.length} sheet: ${result.sheets.join(', ')}`);
                    } else {
                        sheetSelect.innerHTML = '<option value="">-- Tidak ada sheet ditemukan --</option>';
                        sheetSelect.disabled = true;
                        showAlert('warning', 'Tidak ada sheet yang ditemukan di file Excel');
                    }
                } else {
                    sheetSelect.innerHTML = '<option value="">-- Error loading sheets --</option>';
                    sheetSelect.disabled = true;
                    showAlert('error', result.message || 'Gagal memuat daftar sheet');
                }
            })
            .catch(error => {
                console.error('Error loading sheets:', error);
                sheetSelect.innerHTML = '<option value="">-- Error loading sheets --</option>';
                sheetSelect.disabled = true;
                showAlert('error', 'Terjadi kesalahan saat memuat daftar sheet');
            });
        }

        // Add file info display when file is selected
        document.getElementById('file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const sheetSelect = document.getElementById('sheet_name');

            if (file) {
                // Reset dan disable sheet dropdown
                sheetSelect.innerHTML = '<option value="">-- Loading sheets... --</option>';
                sheetSelect.disabled = true;
                
                // Load sheets dari file
                loadSheetsFromFile(file);

                const fileInfo = document.createElement('div');
                fileInfo.id = 'fileInfo';
                fileInfo.style.cssText = `
                    margin-top: 10px;
                    padding: 12px;
                    background: #f8fafc;
                    border: 1px solid #e2e8f0;
                    border-radius: 6px;
                    font-size: 0.875rem;
                    color: #475569;
                `;
                fileInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>üìÑ ${file.name}</strong>
                        <span>${formatFileSize(file.size)}</span>
                    </div>
                `;
                
                // Remove existing file info
                const existingInfo = document.getElementById('fileInfo');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                // Add new file info after file input
                e.target.parentElement.appendChild(fileInfo);
            } else {
                // Reset sheet dropdown jika tidak ada file
                sheetSelect.innerHTML = '<option value="">-- Pilih file Excel terlebih dahulu --</option>';
                sheetSelect.disabled = true;
            }
        });

        // Add CSS animation for alerts
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);

        document.addEventListener('DOMContentLoaded', function() {
            testConnection();
            
            // Validasi real-time untuk periode date
            const periodeInput = document.getElementById('periode_date');
            if (periodeInput) {
                periodeInput.addEventListener('change', function() {
                    const dateValue = this.value;
                    if (dateValue && !validateDate(dateValue)) {
                        showAlert('warning', 'Format tanggal tidak valid. Gunakan format YYYY-MM-DD.');
                        this.focus();
                    }
                });
            }
        });
    </script>
{% endblock %}