{% extends "header.html" %}

{% block title %}Users Management{% endblock %}

{% block content %}
<!-- Sidebar -->
{% include 'sidebar.html' %}

<!-- Main Content -->
<div class="main-content" id="mainContent">
    <div class="content">
        <div class="content-header">
            <h2 class="content-title">Users Management</h2>
            <p class="content-subtitle">Create, update, and delete user accounts</p>
        </div>

        <!-- Users Table -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <span>üë§</span> Users Data
                </h3>
                <button class="btn btn-success btn-sm" onclick="showCreateUserModal()">
                    <i class="fas fa-user-plus"></i> Create User
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="usersDataTable" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Division</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% include 'modals/create_user_modal.html' %}
        {% include 'modals/edit_user_modal.html' %}
        {% include 'modals/reset_password_user_modal.html' %}
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script>
    function showAlert(type, message) {
        // Remove existing alerts
        $('.alert').remove();
        
        const alertClass = type === 'success' ? 'alert-success' : type === 'warning' ? 'alert-warning' : 'alert-danger';
        const alertIcon = type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
        
        const alert = $(`
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${alertIcon} ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        // Insert alert at the top of the main content
        $('.main-content').prepend(alert);
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            alert.alert('close');
        }, 5000);
    }

    function showSuccessModal(itemName, itemType, action = 'created') {
        // Create success modal if it doesn't exist
        let successModal = document.getElementById('successModal');
        if (!successModal) {
            createSuccessModal();
            successModal = document.getElementById('successModal');
        }
        
        // Update modal content
        const modalMessage = document.getElementById('successModalMessage');
        let actionText;
        
        switch(action) {
            case 'deleted':
                actionText = 'deleted and verified successfully';
                break;
            case 'updated':
                actionText = 'updated and verified successfully';
                break;
            case 'created':
            default:
                actionText = 'created and verified successfully';
                break;
        }
        
        modalMessage.innerHTML = `${itemType} <strong>${itemName}</strong> ${actionText}`;
        
        // Show the modal
        const modal = new bootstrap.Modal(successModal);
        modal.show();
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            modal.hide();
        }, 3000);
    }

    function loadUsers() {
        fetch('/users')
            .then(res => res.json())
            .then(data => {
                const table = $('#usersDataTable').DataTable();
                table.clear();
                data.users.forEach(u => {
                    table.row.add([
                        u.username,
                        u.fullname,
                        u.email,
                        u.division,
                        u.role_access,
                        `<button class="btn btn-sm btn-warning" onclick="editUser(${u.id})">Edit</button>
                         <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id}, '${u.username}')">Delete</button>
                         <button class="btn btn-sm btn-info" onclick="showResetPasswordModal(${u.id}, '${u.username}')">Reset Password</button>`
                    ]);
                });
                table.draw();
            });
    }


    function showCreateUserModal() {
        document.getElementById('createUserForm').reset();
        document.getElementById('username_error').textContent = '';
        document.getElementById('email_error').textContent = '';
        document.getElementById('createUserBtn').disabled = false;
        loadDivisionsDropdown('division');
        new bootstrap.Modal(document.getElementById('createUserModal')).show();
    }

    function createSuccessModal() {
        // Create success modal HTML
        const successModalHTML = `
            <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="successModalLabel">‚úÖ Success</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p id="successModalMessage" class="mb-0"></p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Append to body if not exists
        if (!document.getElementById('successModal')) {
            document.body.insertAdjacentHTML('beforeend', successModalHTML);
        }
    }

    function checkUsername(username, userId = null, targetErrorId = 'username_error', targetButtonId = 'createUserBtn') {
        if (!username || username.trim().length < 3) {
            document.getElementById(targetErrorId).textContent = '';
            updateSubmitButton();
            return;
        }

        fetch('/users/check-username', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                username: username.trim(), 
                user_id: userId 
            })
        })
        .then(res => res.json())
        .then(data => {
            const errorElement = document.getElementById(targetErrorId);
            
            if (data.success && data.exists) {
                errorElement.textContent = 'Username sudah ada!';
                errorElement.style.color = 'red';
                errorElement.style.fontSize = '12px';
                errorElement.style.marginTop = '5px';
            } else {
                errorElement.textContent = '';
            }
            updateSubmitButton();
        })
        .catch(error => {
            console.error('Error checking username:', error);
            document.getElementById(targetErrorId).textContent = '';
            updateSubmitButton();
        });
    }

    function checkEmail(email, userId = null, targetErrorId = 'email_error', targetButtonId = 'createUserBtn') {
        // Validasi format email basic
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (!email || !emailRegex.test(email.trim())) {
            document.getElementById(targetErrorId).textContent = '';
            updateSubmitButton();
            return;
        }

        fetch('/users/check-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                email: email.trim(), 
                user_id: userId 
            })
        })
        .then(res => res.json())
        .then(data => {
            const errorElement = document.getElementById(targetErrorId);
            
            if (data.success && data.exists) {
                errorElement.textContent = 'Email sudah terdaftar!';
                errorElement.style.color = 'red';
                errorElement.style.fontSize = '12px';
                errorElement.style.marginTop = '5px';
            } else {
                errorElement.textContent = '';
            }
            updateSubmitButton();
        })
        .catch(error => {
            console.error('Error checking email:', error);
            document.getElementById(targetErrorId).textContent = '';
            updateSubmitButton();
        });
    }

    function checkPassword(password, passwordConfirm, targetErrorId = 'password_error', targetButtonId = 'createUserBtn') {
        const errorElement = document.getElementById(targetErrorId);
        const submitBtn = document.getElementById(targetButtonId);

        // Reset error
        errorElement.textContent = '';

        if (password !== passwordConfirm) {
            errorElement.textContent = 'Password dan konfirmasi password tidak sama';
            errorElement.style.color = 'red';
            errorElement.style.fontSize = '12px';
            errorElement.style.marginTop = '5px';
        } else {
            errorElement.textContent = '';
        }

        // Disable tombol jika ada error
        if (submitBtn) {
            submitBtn.disabled = !!errorElement.textContent;
        }
    }

    function updateSubmitButton() {
        const usernameError = document.getElementById('username_error') || document.getElementById('edit_username_error');
        const emailError = document.getElementById('email_error') || document.getElementById('edit_email_error');
        const submitBtn = document.getElementById('createUserBtn') || document.getElementById('editUserBtn');
        
        if (submitBtn) {
            const hasError = (usernameError && usernameError.textContent) || 
                            (emailError && emailError.textContent);
            submitBtn.disabled = hasError;
        }
    }


    function editUser(id) {
        fetch(`/users/${id}`)
            .then(res => res.json())
            .then(data => {
                const u = data.user;
                if (!u) return showAlert('danger', 'User not found');

                document.getElementById('edit_user_id').value = u.id;
                document.getElementById('edit_username').value = u.username;
                document.getElementById('edit_fullname').value = u.fullname;
                document.getElementById('edit_email').value = u.email;
                
                // Reset error messages untuk edit
                document.getElementById('edit_username_error').textContent = '';
                document.getElementById('edit_email_error').textContent = '';
                document.getElementById('editUserBtn').disabled = false;

                loadDivisionsDropdown('edit_division');
                setTimeout(() => {
                    document.getElementById('edit_division').value = u.division;
                    document.getElementById('edit_role').value = u.role_access;
                    new bootstrap.Modal(document.getElementById('editUserModal')).show();
                }, 200);
            })
            .catch(error => {
                console.error('Error fetching user:', error);
                showAlert('danger', 'Error loading user data');
            });
    }

    function loadDivisionsDropdown(targetSelectId) {
        fetch('/divisions/dropdown')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const targetSelect = document.getElementById(targetSelectId);
                
                if (!targetSelect) {
                    console.error(`Element with ID '${targetSelectId}' not found`);
                    return;
                }
                
                // Clear existing options
                targetSelect.innerHTML = '<option value="" disabled selected>Select division</option>';
                
                // Add division options
                data.divisions.forEach(division => {
                    const option = `<option value="${division}">${division}</option>`;
                    targetSelect.innerHTML += option;
                });
            }
        })
        .catch(error => console.error('Error loading divisions:', error));
    }


    document.getElementById('editUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const id = formData.get('id');
        const data = {
            username: formData.get('username'),
            fullname: formData.get('fullname'),
            email: formData.get('email'),
            division: formData.get('division'),
            role_access: formData.get('role_access')
        };

        // Validation
        if (!Object.values(data).every(value => value && value.trim())) {
            showAlert('danger', 'All fields are required');
            return;
        }

        fetch(`/users/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(r => {
            if (r.success) {
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                showSuccessModal(data.username, 'User', 'updated'); // Menggunakan action 'updated'
                loadUsers();
            } else {
                showAlert('danger', r.message);
            }
        })
        .catch(error => {
            console.error('Error updating user:', error);
            showAlert('danger', 'Error updating user');
        });
    });

    document.getElementById('createUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        if (data.password !== data.password_confirm) {
            showAlert('danger', 'Passwords do not match');
            return;
        }

        fetch('/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(r => {
            if (r.success) {
                bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                showSuccessModal(data.username, 'User', 'created');
                loadUsers();
            } else {
                showAlert('danger', r.message);
            }
        });
    });

    function deleteUser(id, username) {
        if (!confirm(`Delete user "${username}"?`)) return;
        fetch(`/users/${id}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    loadUsers();
                } else {
                    showAlert('danger', data.message);
                }
            });
    }

    function showResetPasswordModal(id, username) {
        document.getElementById('reset_user_id').value = id;
        document.getElementById('reset_username').value = username;
        document.getElementById('reset_new_password').value = '';
        document.getElementById('reset_confirm_password').value = '';
        document.getElementById('reset_password_error').textContent = '';
        document.getElementById('resetPasswordBtn').disabled = false;
        new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
    }

    function checkResetPassword(newPassword, confirmPassword) {
        const errorElement = document.getElementById('reset_password_error');
        const submitBtn = document.getElementById('resetPasswordBtn');

        // Reset error
        errorElement.textContent = '';

        if (newPassword !== confirmPassword) {
            errorElement.textContent = 'Password dan konfirmasi password tidak sama';
            errorElement.style.color = 'red';
            errorElement.style.fontSize = '12px';
            errorElement.style.marginTop = '5px';
        } else {
            errorElement.textContent = '';
        }

        // Disable tombol jika ada error
        if (submitBtn) {
            submitBtn.disabled = !!errorElement.textContent;
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        $('#usersDataTable').DataTable({
            "pageLength": 10,
            "responsive": true,
            "language": {
                "emptyTable": "No users found",
                "info": "Showing _START_ to _END_ of _TOTAL_ users",
                "infoEmpty": "Showing 0 to 0 of 0 users",
                "search": "Search users:",
                "paginate": {
                    "first": "First",
                    "last": "Last",
                    "next": "Next",
                    "previous": "Previous"
                }
            },
            "columnDefs": [
                { "orderable": false, "targets": 5 } // Disable sorting on Actions column
            ]
        });
        
        // Load users data
        loadUsers();
        
        // Load divisions for create modal (pre-load)
        loadDivisionsDropdown('division');

        const createEmailInput = document.getElementById('email');
        if (createEmailInput) {
            createEmailInput.addEventListener('input', function() {
                const email = this.value.trim();
                checkEmail(email, null, 'email_error', 'createUserBtn');
            });
        }

        // Email validation untuk edit user
        const editEmailInput = document.getElementById('edit_email');
        if (editEmailInput) {
            editEmailInput.addEventListener('input', function() {
                const email = this.value.trim();
                const userId = document.getElementById('edit_user_id').value;
                checkEmail(email, userId, 'edit_email_error', 'editUserBtn');
            });
        }
        
        // Username validation untuk create user (existing code)
        const createUsernameInput = document.getElementById('username');
        if (createUsernameInput) {
            createUsernameInput.addEventListener('input', function() {
                const username = this.value.trim();
                checkUsername(username, null, 'username_error', 'createUserBtn');
            });
        }

        // Username validation untuk edit user (existing code)
        const editUsernameInput = document.getElementById('edit_username');
        if (editUsernameInput) {
            editUsernameInput.addEventListener('input', function() {
                const username = this.value.trim();
                const userId = document.getElementById('edit_user_id').value;
                checkUsername(username, userId, 'edit_username_error', 'editUserBtn');
            });
        }

        // Password validation untuk create user
        const passwordInput = document.getElementById('password');
        const passwordConfirmInput = document.getElementById('password_confirm');
        if (passwordInput && passwordConfirmInput) {
            passwordInput.addEventListener('input', function() {
                checkPassword(passwordInput.value, passwordConfirmInput.value, 'password_error', 'createUserBtn');
            });
            passwordConfirmInput.addEventListener('input', function() {
                checkPassword(passwordInput.value, passwordConfirmInput.value, 'password_error', 'createUserBtn');
            });
        }

        // Reset password form submission
        document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const id = document.getElementById('reset_user_id').value;
            const newPassword = document.getElementById('reset_new_password').value;
            const confirmPassword = document.getElementById('reset_confirm_password').value;

            // Validation
            if (!newPassword || !confirmPassword) {
                showAlert('danger', 'All fields are required');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('danger', 'Passwords do not match');
                return;
            }

            fetch(`/users/${id}/reset-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ new_password: newPassword })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
                    showSuccessModal(document.getElementById('reset_username').value, 'User password', 'updated');
                    loadUsers();
                } else {
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                console.error('Error resetting password:', error);
                showAlert('danger', 'Error resetting password');
            });
        });

        // Password validation untuk reset password
        const resetNewPasswordInput = document.getElementById('reset_new_password');
        const resetConfirmPasswordInput = document.getElementById('reset_confirm_password');
        if (resetNewPasswordInput && resetConfirmPasswordInput) {
            resetNewPasswordInput.addEventListener('input', function() {
                checkResetPassword(resetNewPasswordInput.value, resetConfirmPasswordInput.value);
            });
            resetConfirmPasswordInput.addEventListener('input', function() {
                checkResetPassword(resetNewPasswordInput.value, resetConfirmPasswordInput.value);
            });
        }
    });
</script>
{% endblock %}
